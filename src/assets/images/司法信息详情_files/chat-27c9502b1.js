!function(){"use strict";function e(){this.create=function(e,t){return this.ioLink=io.connect(e,t),this},this.close=function(){this.ioLink.disconnect()},this.emitMsg=function(e,t,i,n){return this.ioLink.compress(!1).emit(e,t),i&&i.call(n),this},this.receiveMsg=function(e,t,i,n,a){var i=i||this;return a?this.ioLink.once(e,function(e){n&&$.extend(e,n),t&&t.call(i,e)}):this.ioLink.on(e,function(e){n&&$.extend(e,n),t&&t.call(i,e)}),this}}function t(){"chat"!=window.__domain.chat&&window.console&&window.console.trace&&"[object Function]"==Object.prototype.toString.apply(window.console.trace)&&window.console.trace(arguments)}function i(){var e=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(e)?"Windows Phone":/android/i.test(e)?"Android":/iPad|iPhone|iPod/.test(e)&&!window.MSStream?"iOS":"unknown"}function n(){"iOS"==Ce?_e.chatListWrap[0].scrollTop=_e.chatListWrap[0].scrollHeight-_e.chatListWrap.height():_e.chatListWrap.children().last()[0].scrollIntoView(!1)}function a(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i)}function o(e){var t=100,i=e,n=i-t+1;return Math.floor(Math.random()*n+t)}function s(e){var t,i=!0,a=e.msgType,o={seq:e.seq};switch(a){case"tmpl":t=$.tmpl(be.CHAT_MSG_TPL[e.type],e.data);break;case"serverResp":t=e.data;break;default:t=be.SYS_MSG[e.type]}$.extend(o,{msg:t}),"sessionEnd"==e.type&&(Te.isChangeKF?i=!1:Te.ioLinkStatus="sessionOver"),e.empty&&_e.chatBody.hasClass("regsuccess")&&(e.empty=!1),i&&!e.notip&&(e.empty?_e.chatListWrap.empty().append(Me(be.CHAT_MSG_TPL.sys,o)):_e.chatBody.hasClass("regsuccess")&&"new"==e.act?_e.chatListWrap.append(Me(be.CHAT_MSG_TPL.sys,o)):"update"==e.act?_e.chatBody.hasClass("regsuccess")?$('[data-guid="'+e.seq+'"]').find(".text").html(o.msg):_e.chatListWrap.find(".msg-sys").last().find(".text").html(o.msg):"remove"==e.act&&$('[data-guid="'+e.seq+'"]').remove(),n())}function r(e,t,i,n,a){a&&(a=new Date(+new Date+a));var o=e+"="+escape(t)+(a?"; expires="+a.toGMTString():"")+(n?"; path="+n:"")+(i?"; domain="+i:"");return o.length<4096&&(Oe.cookie=o),this}function c(e){var t=Oe.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null}function l(){var e=c("uin");return e?Math.floor(e.substring(1)):""}function d(e,t,i){var n,a="kf"+e,o=JSON.parse(Pe.get(a));return o&&o.forEach(function(e){e.visitorId==t&&(n=e.total,"set"==i&&(n++,e.total=n))}),"get"==i?n:(Te.msgSyncSum=n,void Pe.set("kf"+e,JSON.stringify(o)))}function u(){var e=arguments.length<=0||void 0===arguments[0]?"add":arguments[0],t=arguments.length<=1||void 0===arguments[1]?"qq":arguments[1],i=_e.header.find("span.title"),n=Te.isMobile?"H5":"PC";"add"==e?"qq"==t&&0==_e.callGroup.find(".btn-callqq").length?_e.callGroup.append(be.HEADER_TPL[n].BTN_CALL_QQ):"tel"==t&&0==_e.callGroup.find(".btn-calltel").length&&_e.callGroup.append(be.HEADER_TPL[n].BTN_CALL_TEL):"remove"==e&&("qq"==t?_e.callGroup.find(".btn-callqq").remove():"tel"==t&&_e.callGroup.find(".btn-calltel").remove()),2==_e.callGroup.children().length?i.addClass("title-mini"):i.removeClass("title-mini")}function p(e,t,i){var n=this,a=$($.tmpl(be.CHAT_MSG_TPL.blackTip,e));_e.chatList.append(a),setTimeout(function(){a.remove(),i&&i.apply(n)},t)}function f(e){var t,i,n=Te.getSignTData,a=Te.receptionist.extUin,o=Te.isInIframe,s=/(ipad|iphone|ipod).*? (ipad)?qq\/([\d.]+)|\bv1_and_sqi?_([\d.]+)(.*? qq\/([\d.]+))?/.test(Te.userAgent),r=e.type;window.bindCallQQEvent=function(e){var t,i,a,r=1e3;return Te.inRegProcess=0,e&&0==e.r&&"undefined"!=typeof e.data.sign?(t=e.data.sign,void(Te.isMobile?o?window.top.postMessage({act:"LAUNCH",type:"PHONE",sign:t,protocol:be.CGI_URL.ROUTE_CHANGE_LOADING.QQ+"?fromWebIm=1&"+$.param(n)+"&protocol="+t},"*"):s?top.location.href=t:top.location.href=be.CGI_URL.ROUTE_CHANGE_LOADING.QQ+"?"+Ue(window.location.href)+"&protocol="+t:"https"===window.location.protocol&&-1===Te.userAgent.indexOf("msie")?window.location.href=t:(i=document.createElement("iframe"),a=document.body,i.style.display="none",a.insertBefore(i,a.firstChild),i.src=t))):void p({text:"点击失败："+e.data.message},r)},"qq"==r?($.extend(n,{roleValue:0}),e.data?$.extend(n,e.data):$.extend(n,{roleData:a,clickid:ve()}),F(n,be.CGI_URL.GET_TENCENT_SCHEME,"bindCallQQEvent")):"tel"==r&&(i=be.CGI_URL.ROUTE_CHANGE_LOADING.LIGHT_TALK+"?source=3&type=1&id="+Te.receptionist.kfUin+"&kfext="+a,t=be.CGI_URL.ROUTE_CHANGE_LOADING.WX+"?url="+encodeURIComponent(i),o?Ie.send({act:"LAUNCH",type:"QQ",protocol:t,sign:i}):setTimeout(function(){return top.location.href=s?i:t},500))}function g(e){var t=arguments.length<=1||void 0===arguments[1]?{type:"qq"}:arguments[1];e.off(Te.clickName).on(Te.clickName,$.proxy(f,null,t))}function h(e,t){return"c2b"==e?-1!=t.indexOf("f_")?t:t.replace(/\[(.*?)\]/g,function(e,t){for(var i=0;i<Ge.humen.length;i++)if(Ge.humen[i]==t)return"[f_"+Ge.index[i]+"]";return e}):"b2c"==e?t:void 0}function m(e){for(var t=e.seq,i=0;i<qe.length;i++)qe[i].seq==t&&(qe.splice(i,1),Te.c2bSeqGroup=qe,Fe.normal.sendFail([e]))}function v(e,t,i){var n,a=Te.chatSocket,o=Te.wpaDetail,s=Te.ioLinkStatus;if(a.ioLink&&a.ioLink.disconnected&&~s.indexOf("over")&&(s="over",Te.ioLinkStatus="over"),t.data=h(e,t.data),"welcome"!=i)if("c2b"==e){if($.extend(t,{clickid:o.clickid}),"over"==s)n=t,Ve().reConnect();else if("sessionOver"==s)n=t,Ve().reConnect();else if("normal"==s){var r=+new Date,c={seq:t.seq,data:t.data,type:t.type};Te.isChangeKF&&(a.emitMsg(be.SOCKET_CMD.KF_CHANGE.EMIT,{kf:""}),_e.chatListWrap.find(".btn-newkf").addClass("disabled"),u(),g(_e.callGroup.find(".btn-callqq"),{type:"qq"})),2==t.type?$.extend(c,{imgSrc:t.imgSrc}):"",Te.c2bDBsaveData.push(c),qe.push({sendTime:r,seq:t.seq}),Te.c2bSeqGroup=qe,setTimeout(function(){m(t)},be.SOCKET_OPTS.C2B_TIMEOUT),n=null,a.emitMsg(be.SOCKET_CMD.C2B.EMIT,t)}Te.reSendC2bMsg=n,4739345==t.data&&(Pe.clear(),Te.win.location.reload())}else"b2c"==e&&("msg"==i?a.emitMsg(be.SOCKET_CMD.B2C.EMIT,{date:t.date,seq:t.seq,sortseq:t.sortseq,csrf:t.csrf}):"",De.saveMsg(e,t))}function S(e,t){for(var i=e.toString().length;t>i;)e="0"+e,i++;return e}function b(e){var e=new Date(e),t=S(e.getMonth()+1,2),i=S(e.getDate(),2),n=S(e.getHours(),2),a=S(e.getMinutes(),2);return t+"-"+i+"&nbsp;"+n+":"+a}function T(e){ke?e-ke>be.VIEW_OPTS.TIME_INTERVAL&&(ke=e,_e.chatListWrap.append(Me(be.CHAT_MSG_TPL.time,b(ke)))):(ke=e,_e.chatListWrap.append(Me(be.CHAT_MSG_TPL.time,b(ke))))}function y(e){window.open(e,"_blank")}function _(e){var t;_e.chatBody.append('<div class="mod-fullscreen"><div class="overlay"></div></div>'),t=$(".mod-fullscreen"),Te.isMobile&&t.on("touchmove",function(e){return e.preventDefault(),!1}),e&&e(t)}function w(e,t){var i=new Image,n=$(window),a=0,o={width:1,height:1},s={width:0,height:0},r={width:n.innerWidth()-160,height:n.innerHeight()},c={width:0,height:0};i.onload=function(){return s={width:i.width,height:i.height},a=Math.max(s.width,s.height),o={width:s.width/s.height,height:s.height/s.width},s.width<=r.width&&s.height<=r.height?c={width:s.width,height:s.height}:s.width==a?(c.width=r.width,c.height=Math.floor(c.width*o.height)):(c.height=r.height,c.width=Math.floor(c.height*o.width)),e.find("img").attr({width:c.width,height:c.height,src:t}).css({"margin-top":0-c.height/2,"margin-left":0-c.width/2}),c},i.src=t}function C(e,t){var i=t.code;switch(i){case 0:v("c2b",{data:t.fileId,seq:e.seq,wordMsgSeq:o(be.SOCKET_OPTS.SEQ_RANGE.C2B_FOR_PC),date:e.seq.date,type:2,imgSrc:t.uri},"msg"),t._raw&&(e.blobUrl=t.uri,replacePlaceholder(e));break;case 1:P().sendFail(e,"overSumLimit");break;case 2:P().sendFail(e,"notSupport");break;default:P().sendFail(e,"uploadError")}}function I(e,t,i){function n(e){Ie.send({act:"OPEN_IMG",data:{url:e}})}var a,o,s=e.is("img")?e:e.find("p.image");Te.isMobile?s.off("tap").on("tap",function(){_(function(e){e.append('<img class="big-image" src="'+t+'"/>'),e.on("touchend",function(t){e.remove()})})}):($("body").delegate(s,"click",function(e){"INPUT"!=e.target.nodeName&&e.preventDefault()}),s.off("click").on("click",function(e){Te.isInIframe?i?(a=new FileReader,a.onload=function(e){n(e.target.result)},a.readAsDataURL(i.content)):n(t):(o=t?t:i.blobUrl,_(function(e){e.append('<div class="img-wrap"><img class="" src=""/><a href="javascript:;" class="btn-close"></a></div>'),w(e,o),e.on("click","a.btn-close",function(t){t.preventDefault(),e.remove()})}))}))}function E(e,t){e.onload=function(){$(this).parent().css("background-image","none"),t&&n()}}function M(e,t){var i,e="undefined"!=typeof Te.win.emoji?Te.win.emoji.replace_unified(e):e,n=Te.isMobile?be.CGI_URL.QQ_FACE:be.CGI_URL.COMP_SOURCE_URL+"img/qq/";return e.replace(/\[(.*?)\]/g,function(e,a){if(0==a.indexOf("f")){a=a.match(/\d+/g);for(var o=0;o<Ge.index.length;o++)if(Ge.index[o]==a){i=o;break}}else if("b2c"!=t)for(var o=0;o<Ge.humen.length;o++)if(Ge.humen[o]==a){i=o;break}return i||0===i?'<img src="'+n+i+'.png" class="face"/>':e})}function O(e){var t;Te.isRealSendMsg&&Te.win.FormData&&(t=new FormData,t.append("media",e.content),t.append("visitId",Te.receptionist.visitorId),t.append("receptionUin",Te.receptionist.extUin),$.ajax({url:be.CGI_URL.UPLOAD_IMG,data:t,processData:!1,contentType:!1,type:"POST",timeout:5e4,error:function(){P().sendFail(e,"uploadError")},success:function(t){C(e,t)}}))}function L(){function e(e){var t="kf"+Te.receptionist.kfUin,o=JSON.parse(Pe.get(t));0==a.isLoad&&(a.isLoad=1,o&&o.forEach(function(e){e.visitorId==Te.receptionist.visitorId&&(a.sum=e.total)}),a.sum>0&&(i(e),1!=a.pageNum||e?"":n()))}function t(e,t){var i,n=e.dir,a=parseInt($.trim(e.type)),t=t||"down";switch(a){case 1:i=$(M(Me(be.CHAT_MSG_TPL[n],e),n));break;case 2:n="c2b"==n?"c2bImage":"b2cImage",i=$(Me(be.CHAT_MSG_TPL[n],e)),E(i.find("p.image img")[0]);break;case 3:$.extend(e.data,{currentVersion:Te.menuDetail.currentVersion}),e.data.config||$.extend(!0,e.data,{config:{menu:0,button:0}}),i=$($.tmpl(be.CHAT_MSG_TPL.menuMsgNormal,e.data)),Ne().bindEvents(i);break;default:log("历史消息单条渲染失败")}_e.chatListWrap["down"==t?"append":"prepend"](i),/Image/g.test(n)&&I(i,e.data.replace(/\/720$/g,"/0"))}function i(e){var n,s,r,c,l=Te.receptionist.kfUin,d=Te.receptionist.visitorId,u=be.VIEW_OPTS.HISTORY_MSG.PER_NUM;r=a.sum-u,0>r&&(r=0);for(var p=a.sum;p>r;p--)n="kf"+l+"vId"+d+"index"+(p-1),s=JSON.parse(Pe.get(n)),s&&(t(s,"up"),s.time&&_e.chatListWrap.prepend(Me(be.CHAT_MSG_TPL.time,b(s.time)))),a.sum--;0==a.pageNum?o=_e.chatListWrap[0].scrollHeight+60:setTimeout(function(){o=_e.chatListWrap[0].scrollHeight-o,_e.chatListWrap[0].scrollTop=o,o=_e.chatListWrap[0].scrollHeight},20),a.pageNum++,a.sum<=0?a.pageNum=1:(c=$(Me(be.CHAT_MSG_TPL.msgLoad.getMsg,be.VIEW_OPTS.HISTORY_MSG.GET_MSG)),_e.chatListWrap.prepend(c),c.find("a").one(Te.clickName,function(){o=e?_e.chatListWrap[0].scrollHeight:o,c.html(Me(be.CHAT_MSG_TPL.msgLoad.loading,be.VIEW_OPTS.HISTORY_MSG.LOADING)),setTimeout(function(){c.remove(),i()},200)}))}var a={sum:0,pageNum:0,isLoad:0},o=0;return{start:e,renderSigle:t}}function k(){function e(e,i){var a=arguments.length<=2||void 0===arguments[2]?"msg":arguments[2],o=arguments[3],s=_e.chatListWrap[0],r=o,c=t(e,i),l=Te.isRealSendMsg;~e.indexOf("b2c")&&s.scrollHeight-s.scrollTop==s.getBoundingClientRect().height&&(r=!0),T(i.date),_e.chatListWrap.append(c),"c2b"!=e&&"c2bImage"!=e||"msg"!=a||!l||$('[data-guid="'+i.seq+'"]').find("i").addClass("loading loading-s"),("open"==Te.imStatus&&"c2b"==e||r)&&n(),"c2bImage"!=a&&l&&v(e,i,a)}function t(e,t){var i="c2b"==e?new RegExp(/\n/g):new RegExp(/\r/g);if(("undefined"==typeof t.avatar||0==t.avatar.length)&&(t.avatar=Te.defaultAvatar),"b2c"==e&&2==t.type){var n=t.data.replace(/\/720$/g,"/0"),a=$(Me(be.CHAT_MSG_TPL.b2cImage,t));return I(a,n),E(a.find("p.image img")[0]),a}return $(M(Me(be.CHAT_MSG_TPL[e],t).replace(i,"<br/>")))}function i(e){for(var t=0,i=e.length;i>t;t++){var n=e[t],a=n.seq,o=(n.data,$('[data-guid="'+a+'"]').find("i"));o.removeAttr("class").addClass("icon-fail"),o.data("reSendData",n),o.off(Te.clickName),o.one(Te.clickName,function(){var e=$(this).data("reSendData");Te.reSendC2bMsg=e,$(this).removeClass("icon-fail").addClass("loading loading-s"),v("c2b",e,"msg")})}}function a(e){var t=e.body.seq,n=$('[data-guid="'+t+'"]').find(".loading"),a=(n.parent(),Te.c2bSeqGroup);if("success"==e.result&&t){n.remove(),De.saveMsg("c2b",{seq:t,date:e.body.date}),Te.isChangeKF=0;for(var o=0;o<a.length;o++){a[o].seq==t&&(a.splice(o,1),Te.c2bSeqGroup=a);break}}else i([{data:e.body.data,seq:e.body.seq,wordMsgSeq:e.body.wordMsgSeq}])}function o(t){var i=t.body.seq;-1==$.inArray(i,He)&&(e("b2c",{avatar:Te.receptionist.avatar,name:Te.receptionist.name,data:t.body.data,date:t.body.date,seq:t.body.seq,type:t.body.type,csrf:t.body.csrf,sortseq:t.body.sortseq}),"close"==Te.imStatus&&$e.set(Te.receptionist,Te.wpaDetail.wpaId,function(e){Te.isMobile&&Ie.send({act:"UNREAD",data:{number:e,onlyOpen:!0}})}),He.push(i))}return{render:e,conventSigle:t,sendFail:i,sendRet:a,renderB2C:o}}function P(){function e(e,t){var i=e;$.extend(i,{date:+new Date}),k().render("c2bImage",{seq:e.seq,date:e.date},"msg"),t&&renderImgSendFail(e,t)}function t(e){var t=e.seq,i=$('[data-guid="'+t+'"]').find("img");e.blobUrl?(i.attr("src",e.blobUrl),I(i,e.blobUrl),E(i[0],!0),e.size>be.IMG_UPLOAD_OPTS.MAX_SIZE?renderImgSendFail(e,"overSumLimit"):O(e)):e.DataURL&&(i.attr("src",e.DataURL),E(i[0],!0),e.size>be.IMG_UPLOAD_OPTS.MAX_SIZE&&renderImgSendFail(e,"overSumLimit"))}function i(e,t){var i=e.seq,a=$('[data-guid="'+i+'"]'),o=a.find("i");o.removeClass("loading loading-s").addClass("icon-fail").data("reason",t),"uploadError"==t?o.off(Te.clickName).on(Te.clickName,function(){$(this).removeClass("icon-fail").addClass("loading loading-s"),O(e)}):a.find("p.image").addClass(t),n()}return{render:e,replacePlaceholder:t,sendFail:i}}function x(e){var t={welcome:!1,offline:!1};return e.body.o_u_info||!e.body.u_info.welcome||e.body.nowelcome||(t.welcome=!0,Fe.normal.render("b2c",{avatar:Te.receptionist.avatar,name:e.body.u_info.name,data:e.body.u_info.welcome,date:e.body.date,seq:e.body.seq},"welcome")),e.body.offlineMsgNum>0&&(t.offline=!0,t.welcome?Be.render.load(e,e.body.seq):Be.render.load(e)),t}function D(e){var t=(e.body.u_info.phone,e.body.c_info.name),i={},n=Te.isMobile?_e.header.find("span.title"):_e.header.find("span.name");s({type:"regSuccess",act:"update",seq:Te.inRegProcess}),Te.inRegProcess=0,_e.chatBody.hasClass("regsuccess")||(document.title=Te.isMobile?t:"与"+t+"交谈中",_e.chatListWrap.empty(),n.text(t),_e.chatBody.addClass("regsuccess"),_e.chatListWrap.removeClass("chat-initial"),_e.chatBtnSend.addClass("enabled"),_e.btnUpload.addClass("enabled")),i=x(e),Fe.historyMsg.start(i.offline),e.body.u_info.type?"guide"!=e.body.u_info.type||e.body.o_u_info||(Te.menuDetail.active=1,u("remove","qq"),Te.isMobile&&u("remove","tel"),Ne().render.start(e.body.u_info)):(Te.menuDetail.active=0,Te.isRealSendMsg=1,u(),g(_e.callGroup.find(".btn-callqq"),{type:"qq"}))}function A(e){var i=e.body.data,a=e.body.offline||0,o=Te.receptionist,s=Te.wpaDetail,r=Te.chatSocket,c=Te.imStatus;return 1==i&&Te.isMobile?void(i="tel"):(2==i&&(i="qq"),a&&_e.chatListWrap.append(Me(be.CHAT_MSG_TPL.sys,be.SYS_MSG["call"+i])),_e.chatListWrap.append(Me(be.CHAT_MSG_TPL["call"+i],o)),g(_e.chatListWrap.find(".btn-act"),{type:i}),n(),r.emitMsg(be.SOCKET_CMD.ROUTE.EMIT,{csrf:e.body.csrf,seq:e.body.seq}),void("close"==c&&$e.set(o,s.wpaId,function(e){t(e),Te.isMobile&&Ie.send({act:"UNREAD",data:{number:e}})},!1)))}function R(e){var t=e.data,i=(Te.receptionist,Te.chatSocket);i.emitMsg(be.SOCKET_CMD.SESSION_MSG.EMIT,{csrf:e.csrf,seq:e.seq,type:e.type,time:e.time}),$.extend(Te.receptionist,{extUin:t.uin,name:t.name,avatar:t.face||Te.defaultAvatar,resign:t.position}),s({type:"b2cKfChange",msgType:"tmpl",act:"new",data:{name:Te.receptionist.name}})}function G(e){var t=e.body,i=t.type||"unknown";switch(i){case 1000010:R(t);break;case 1000011:We().initialize(t)}}function U(){s({type:"sessionEnd",act:"new"}),Te.kfChangeTip||(Te.ioLinkStatus="sessionOver",Te.wpaDetail.extUin=Te.receptionist.extUin,Te.isChangeKF=0)}function q(){Ke.receiveMsg(be.SOCKET_CMD.B2C.RECEIVE,Fe.normal.renderB2C),Ke.receiveMsg(be.SOCKET_CMD.C2B.RECEIVE,Fe.normal.sendRet),Ke.receiveMsg(be.SOCKET_CMD.SESSION_MSG.RECEIVE,G),Ke.receiveMsg(be.SOCKET_CMD.OVER.RECEIVE,U),Ke.receiveMsg(be.SOCKET_CMD.ROUTE.RECEIVE,A)}function N(e,i){var e=e.body,n=$(i.target),a=Te.getSignTData,o=Te.receptionist,s=parseInt(a.roleValue);if(!n.hasClass("disabled")){switch(n.addClass("disabled"),Te.chatSocket.emitMsg(be.SOCKET_CMD.KF_CHANGE.EMIT,{kf:""}),4==a.invitationType&&(1==Te.wpaDetail.reception.type?s=0:2==Te.wpaDetail.reception.type&&(s=1)),s){case 0:Te.wpaDetail.extUin=a.roleData;break;case 1:Te.wpaDetail.extUin="group";break;case 2:Te.wpaDetail.extUin=o.kfUin;break;default:t("unknown roleValue")}Ve().reConnect()}}function H(){var e=Te.win.location.href,t="0"==Ue(e,"linkType")?2:3,i=Te.wpaDetail,n=Te.receptionist,a=i.clickid;$.ajax({url:be.CGI_URL.ACT_RPT,data:{mid:"",id:i.wpaId,kfuin:n.kfUin,kfext:Ue(e,"kfext"),cate:Ue(e,"cate"),type:Ue(e,"type"),eventtp:t,tpForm:t,refurl:"undefined"!=typeof document.referrer?document.referrer:"",ua:Te.userAgent,eptype:Te.isMobile?2:1,clickid:a,pid:a,clickType:6,visitorid:n.visitorId,tptype:9},type:"POST",timeout:3e3,dataType:"json"})}function F(e,t,i,n){var a=i||"chatStart",r=t||be.CGI_URL.GET_SIGT,c=o(be.SOCKET_OPTS.SEQ_RANGE.C2B_FOR_PHP);return"underfined"!=typeof e.visitorId&&Number(e.visitorId)?(H(),$.extend(Te.getSignTData,e),$.extend(e,{ftype:Te.isMobile,rolekey:"roleQQ",cb:a}),Te.win.chatStart=function(e){var t=e.data.sigT;Te.isGetSignT=1,0==e.r?Ve().prepareRegData(t):s({type:"sigTfail",empty:!0})},setTimeout(function(){Te.isGetSignT||s({type:"sigTtimeOut",empty:!0})},be.SOCKET_OPTS.SIGT_TIMEOUT),$.ajax({type:"get",url:r,data:e,dataType:"jsonp",timeout:be.SOCKET_OPTS.SIGT_TIMEOUT,error:function(e){}}),void(_e.chatBody.hasClass("regsuccess")&&n&&(s({type:"startGetSigT",seq:c,act:"new"}),Te.inRegProcess=c))):void s({type:"noVisitorId",empty:!0})}function B(){var e=0;return function(){var t=arguments.length<=0||void 0===arguments[0]?0:arguments[0];return e+=t}}function W(e){var t=e.act,i={},n={},a=Te.wpaDetail,o=Te.chatSocket;switch(t){case"INIT":var s={kfUin:e.kfuin,visitorId:e.visitorid,wpaId:e.wpaId};!Te.isGetSkin&&Qe().getData({kfuin:e.kfuin,wpaId:e.wpaId,key:e.wpaKey}),Te.imStatus="close",i=$e.get(s),"undefined"!=typeof i.number&&i.number>0&&($.extend(n,e,{type:"unReadMsg"}),we.statusBar.data("virtualWPAData",n),Je(i.number),$e.render("update",i.number,{name:i.name,status:"留言了"}),Ie.send({act:"SHOW"})),$.extend(Te.receptionist,{visitorId:e.visitorid,kfUin:e.kfuin});break;case"OPEN":var r={};if($.extend(Te.receptionist,{visitorId:e.visitorid,kfUin:e.kfuin}),we.page.removeClass("page-minify").addClass("page-inframe"),$e.reset(Te.receptionist),$e.render("reset"),Te.imStatus="open",e.onlyOpen)return;1==e.invitationType||2==e.invitationType?$.extend(e,{roleData:e.receptionUin,roleValue:0}):4==e.invitationType?$.extend(e,{roleData:e.reception.cuin,roleValue:e.reception.type}):3==e.invitationType&&$.extend(e,{roleData:e.receptionUin,roleValue:0,extUin:e.receptionUin}),"undefined"!=typeof e.invitationType&&(delete e.wpaId,delete e.wpaKey),r={kfuin:e.kfuin,visitorId:e.visitorid,roleValue:e.roleValue,roleData:e.roleData,invitationType:e.invitationType},e.isClickWpa&&$.extend(r,{cate:e.cate,type:e.type,clickid:e.clickid,fid:e.wpaId,pid:e.pid,qid:e.qid,clickType:e.clickType,tptype:e.tptype,eptype:e.eptype,tpForm:e.tpForm}),a.wpaKey||a.wpaId||we.chatBody.hasClass("regsuccess")?a.wpaKey!=e.wpaKey&&a.wpaId!=e.wpaId&&(Te.wpaDetail=e,Te.originGetSigTData=r,F(r)):(Te.wpaDetail=e,Te.originGetSigTData=r,F(r));break;case"UPDATE_UNREAD":n=a={type:"offlineMsg",roleData:e.receptionUin,roleValue:e.roleValue,extUin:e.receptionUin,kfuin:e.kfuin,visitorid:Te.receptionist.visitorId,invitationType:3},we.statusBar.data("virtualWPAData",n),$e.render("update",Je()+parseInt(e.number),{name:e.receptionName,status:"交谈中"}),Ie.send({act:"SHOW"});break;case"DISCONNECT":"undefined"!=typeof o.ioLink&&o.ioLink.disconnect()}}function K(e){$("body").delegate('a[href^="javascript:"]',"click",function(e){e.preventDefault()}),$(window).bind("beforeunload",function(){return e.apply(this,arguments)})}function V(){K(function(){return"您正在与客服会话，是否离开"})}function j(e){var t=0;if(document.selection){e.focus();var i=document.selection.createRange();i.moveStart("character",-e.value.length-1),t=i.text.length}else(e.selectionStart||"0"==e.selectionStart)&&(t=e.selectionStart);return t}function Q(e,t){if(e.setSelectionRange)e.focus(),e.setSelectionRange(t,t);else if(e.createTextRange){var i=e.createTextRange();i.collapse(!0),i.moveEnd("character",t),i.moveStart("character",t),i.select()}}function J(e,t,i){var n=document.getElementsByTagName("script"),a=n[n.length-1],o=document.createElement("script"),s=!1;o.src=e,o.async=!0,a.parentNode.insertBefore(o,a),o.onload=o.onreadystatechange=function(){s||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(s=!0,t&&t.apply(i,arguments),o.onload=o.onreadystatechange=null)}}function Y(){we.faceList.on("show",function(){we.faceList.addClass("slideup"),Xe.render()}),we.faceList.on("hide",function(){we.faceList.removeClass("slideup")}),$("body").on("click",function(e){var t=$(e.target);0==t.parents(".chat-face").length&&0==t.parents(".btn-face").length&&we.faceList.trigger("hide")})}function z(){var e=window.emoji=!1,t=~Te.userAgent.indexOf("mac os");Y(),!Te.isInIframe&&V(),t&&we.chatPostArea.prop("placeholder","请输入，按Enter直接发送消息，Shift+Enter换行"),we.chatPostArea.on("init",function(){we.chatPostArea.val("")}),we.btnFace.on("click",function(){we.faceList.trigger(we.faceList.hasClass("slideup")?"hide":"show")}),J(je.CGI_URL.COMP_SOURCE_URL+"js/lib/emoji.js",function(){e=new EmojiConvertor,e.img_sets.apple.path=je.CGI_URL.COMP_SOURCE_URL+"img/emoji/",window.emoji=e})}function X(e,t,i,n,a){_(function(o){o.append('<div class="confirm"><p class="text">'+e+'</p><p class="btn-wrap"><a href="javascript:;">确定</a><a href="javascript:;">取消</a></p></div>'),o.find(".btn-wrap a").eq(0).on("tap",function(){o.remove(),t&&t.call(i)}),o.find(".btn-wrap a").eq(1).on("tap",function(){o.remove(),n&&n.call(a)})})}function Z(){var e=window.navigator.connection||window.navigator.webkitConnection||null;return e&&e.type&&"wifi"==e.type?!0:!1}function ee(e){this.options={},$.extend(this.options,e),this.initialize()}function te(){var e=WebUploader.create({auto:!0,swf:je.CGI_URL.COMP_SOURCE_URL+"swf/Uploader.swf",server:je.CGI_URL.UPLOAD_IMG,formData:{visitId:Te.receptionist.visitorId,receptionUin:Te.receptionist.extUin},fileVal:"media",pick:"#btn-swfupload",fileNumLimit:je.IMG_UPLOAD_OPTS.MAX_SUM,fileSingleSizeLimit:je.IMG_UPLOAD_OPTS.MAX_SIZE,accept:{title:"图片文件",extensions:je.IMG_UPLOAD_OPTS.ACCEPT_TYPE_SWFUPLOAD,mimeTypes:"image/*"},thumb:{width:200,height:200,quality:90,allowMagnify:!1,crop:!1,type:""},compress:!1});$(".upload-placeholder").hover(function(){we.btnUpload.addClass("hover")},function(){we.btnUpload.removeClass("hover")}),e.on("fileQueued",function(t){var i={seq:o(je.SOCKET_OPTS.SEQ_RANGE.C2B_FOR_PHP),date:+new Date};Fe.normal.render("c2bImage",{seq:i.seq,date:i.date},"msg"),$.extend(t,i),e.makeThumb(t,function(e,t){i.DataURL=t,$.extend(i,{DataURL:t}),Fe.image.replacePlaceholder(i)},200,200)}),e.on("uploadSuccess",function(e,t){var i={seq:e.seq,date:e.data};Fe.renderUploadImgRet(i,t)}),e.on("uploadError",function(e,t){Fe.image.sendFail(e,"notSupport")}),e.on("error",function(e){"Q_EXCEED_NUM_LIMIT"==e&&Fe.image.sendFail(file,"overSumLimit")})}function ie(){var e=0,t=~Te.userAgent.indexOf("mac os")?16:17;we.chatBtnSend.on("click",function(e){ne()}),we.chatPostArea.on("keydown",function(i){i.which==t&&(e=1),13!=i.which||1!=e||isMacOS?13==i.which&&0==e&&(i.preventDefault(),ne()):we.chatPostArea.val(we.chatPostArea.val()+"\r\n").scrollTop(we.chatPostArea.prop("scrollHeight")-we.chatPostArea.outerHeight())}).on("keyup",function(i){i.which==t&&(e=0)}),window.FormData?new ee({$trigger:we.btnUpload,$inputTrigger:we.uploadInput,isNeedWifiTip:!1,initializeCallBack:function(){we.chatPostArea.trigger("slideDown")},events:{preview:function(e,t){Fe.image.render(e,t)},replacePlaceholder:function(e){Fe.image.replacePlaceholder(e)}}}):window.WebUploader&&te()}function ne(){var e=$.trim(we.chatPostArea.val()),t=Te.menuDetail;if(0!=e.length){var i={data:e,seq:o(je.SOCKET_OPTS.SEQ_RANGE.C2B_FOR_PHP),type:1,wordMsgSeq:o(je.SOCKET_OPTS.SEQ_RANGE.C2B_FOR_PC),date:+new Date+Te.serverClientTimeDiff};t.active&&(Te.isRealSendMsg=t.defaultConfig.active,t.defaultConfig.active&&($.extend(Te.getSignTData,{roleValue:t.defaultConfig.roleValue,roleData:t.defaultConfig.roleData}),Te.ioLinkStatus="over")),Fe.normal.render("c2b",i),we.chatPostArea.trigger("init")}}function ae(){var e={};we.page.removeClass("page-popup").addClass("page-minify"),$(".btn-back").on("click",function(e){Ie.send({act:"CLOSE",kfuin:Te.receptionist.kfUin}),Te.imStatus="close",we.page.removeClass("page-inframe").addClass("page-minify"),we.statusBar.find(".name").text(Te.receptionist.name).end().find(".status").text("交谈中")}),$(document).delegate("div.title-minify","click",function(){e=$(this).data("virtualWPAData"),we.page.hasClass("page-minify")&&(Ie.send({act:"OPEN",isPost2Parent:!1}),e&&($.extend(e,{act:"OPEN",isPost2Parent:!0}),window.postMessage(e,"*")),we.page.removeClass("page-minify").addClass("page-inframe"))})}function oe(e){J(be.CGI_URL.STATUS_MANAGER,function(){"undefined"!=typeof e&&Ie.receive(e)})}function se(){function e(){return Math.round(2147483647*(Math.random()||.5))*+new Date%1e10}function t(){var e=c(a);return"undefined"!=typeof window.isLocalStorageSupported&&window.isLocalStorageSupported&&(e?Pe.set(a,e):e=Pe.get(a)),e}function i(){var t=e();return"undefined"!=typeof window.isLocalStorageSupported&&window.isLocalStorageSupported?Pe.set(a,t):r(name,t,null,"/",31536e6),t}var n,a="tencentSig";return n=t(),n||(n=i()),n}function re(e){var t=["kfuin","roleValue","roleData","fid","clickid","waitTime","callImType"],i=Te.win.location.href,n=se(),a={visitorId:n,cate:7,type:10,pid:Ze,qid:Ze,clickType:6,tptype:9,eptype:Te.isMobile?1:2,tpForm:2},o={},s={};t.forEach(function(e){a[e]=Ue(i,e)}),"undefined"!=typeof a.clickid&&a.clickid?Te.wpaDetail.clickid=a.clickid:Te.wpaDetail.clickid=a.clickid=Ze,o.visitorId=n,o.kfUin=a.kfuin,s.wpaId=Ue(i,"fid"),s.wpaKey=Ue(i,"key"),$.extend(Te.receptionist,o),$.extend(Te.wpaDetail,s),Te.originGetSigTData=a,e&&e(),F(a)}function ce(){var e,t=function(e,t){return""!==e?e+t.slice(0,1).toUpperCase()+t.slice(1):t},i=function(){var i=!1;return"number"==typeof window.screenX&&["webkit","moz","ms","o",""].forEach(function(n){0==i&&void 0!=document[t(n,"hidden")]&&(e=n,i=!0)}),i}(),n=function(){return i?document[t(e,"hidden")]:void 0},a=function(){return i?document[t(e,"visibilityState")]:void 0};return{hidden:n(),visibilityState:a(),visibilitychange:function(t,o){return o=!1,i&&"function"==typeof t?document.addEventListener(e+"visibilitychange",function(e){this.hidden=n(),this.visibilityState=a(),t.call(this,e)}.bind(this),o):void 0}}}function le(){this.version="2.0.0",this.start=function(){z(),Te.regSuccessCallBack=ie,Te.isInIframe?(Ie.receive(W),ae()):(oe(W),re(function(){!Te.isGetSkin&&Qe().getData({kfuin:Te.receptionist.kfUin,wpaId:Te.wpaDetail.wpaId,key:Te.wpaDetail.wpaKey})}))}}var de=function(){return window.parent==window?!1:!0}(),ue=window,pe=ue.document,fe="QD.",ge=function(e){return e.toString(36)},he=function nt(e){var nt=1;if(e){var t=0;nt=0;for(var i=e.length-1;i>=0;i--)t=e.charCodeAt(i),nt=(nt<<6&268435455)+t+(t<<14),t=266338304&nt,nt=0!=t?nt^t>>21:nt}return nt},me=function at(){var at;try{var e=new Uint32Array(1);ue.crypto.getRandomValues(e),at=2147483647&e[0]}catch(t){at=Math.floor(2147483648*Math.random())}return at},ve=function(e){var t=ue.navigator.userAgent+(pe.cookie?pe.cookie:"")+(pe.referrer?pe.referrer:"")+ue.location.href,i=ge(me()^2147483647&he(t))+"."+ge(me())+"."+ge(+new Date);return e?fe+i:i},Se=9,be={VIEW_OPTS:{POST_MAX_ROW:3,TIME_INTERVAL:12e4,HISTORY_MSG:{PER_NUM:10,GET_MSG:"点击加载更多历史消息",LOADING:"正在加载历史消息"},OFFLINE_MSG:{LOADING:"正在加载新消息",FAIL:"新消息加载失败，点击重试",OVER:"以下为未读消息"},MENU_MSG:{LOADING:"正在加载菜单导航",FAIL:"菜单导航加载失败，点击重试"}},CGI_URL:{SOCKET_CHAT:"https://"+__domain.chat+".qidian.qq.com",STATUS_MANAGER:"https://bqq.gtimg.com/qidian/chatClient/release/rel/status/js/report-f0e35f79f.js",QQ_FACE:"https://"+__domain.source+".com/qidian/chatClient/release/comp/img/qq/",GET_SIGT:"https://"+__domain.admin+".qidian.qq.com/webim/webImLogin/getSigT",GET_TENCENT_SCHEME:"https://"+__domain.admin+".qidian.qq.com/tp/wpaCall/getWebProtocol",UPLOAD_IMG:"https://"+__domain.admin+".qidian.qq.com/webim/pic/upload",ROUTE_CHANGE_LOADING:{QQ:"https://"+__domain.admin+".qidian.qq.com/template/blue/wpa/link.html",WX:"https://"+__domain.admin+".qidian.qq.com/template/blue/mp/menu/wx-jump-phone.html",LIGHT_TALK:"https://"+__domain.admin+".qidian.qq.com/lighttalk/CallCheck"},GET_OFFLINE_MSG:"https://"+__domain.admin+".qidian.qq.com/webim/offlineMessage/getMessages",COMP_SOURCE_URL:"https://"+__domain.source+".com/qidian/chatClient/release/comp/",GET_MENU_URL:"https://"+__domain.admin+".qidian.qq.com/webim/innerPage/getNav",GET_FEEDBACK_RET:"https://"+__domain.admin+".qidian.qq.com/webim/innerPage/feedBack",ACT_RPT:"https://"+__domain.admin+".qidian.qq.com/ar/ActCap/ActRpt"},SOCKET_OPTS:{OPTS:{path:"/session",reconnectionDelay:1e4,reconnectionDelayMax:2e4,reconnectionAttempts:2,timeout:2e4},C2B_TIMEOUT:4e3,SIGT_TIMEOUT:6e4,REG_TIMEOUT:6e4,SEQ_RANGE:{C2B_FOR_PHP:2147483647,C2B_FOR_PC:65535}},IMG_UPLOAD_OPTS:{MAX_SUM:Se,MAX_SIZE:2097152,MAX_WIDTH:540,MAX_HEIGHT:960,JPG_COMPRESS_RATIO:60,ACCEPT_TYPE:["image/jpeg","image/jpg","image/bmp","image/png","image/gif"],ACCEPT_TYPE_SWFUPLOAD:"gif,jpg,jpeg,bmp,png"},MSG_DB_OPTS:{NAME:"Qidian WebIM History Message Database",CURRENT_VERSION:2},FB_OPTS:{levelDesc:["非常不满意","不满意","一般","满意","非常满意"],availLetterSum:60,delayTime:500},HEADER_TPL:{BTN_BACK:'<a href="javascript:;" class="btn-back"><svg><use xlink:href="#back"/></svg></a>',H5:{BTN_CALL_QQ:'<a href="javascript:;" class="btn-callqq"><svg><use xlink:href="#qq"/></svg></a>',BTN_CALL_TEL:'<a href="javascript:;" class="btn-calltel"><svg><use xlink:href="#tel"/></svg></a>'},PC:{BTN_CALL_QQ:'<a href="javascript:;" class="btn-callqq"><i class="icon-qq"></i>去QQ交谈<i class="icon-arrow-right"></i></a>'}},SYS_MSG:{sessionEnd:"本次咨询已结束，发送消息可开始新的咨询",disconnect:"当前会话网络已中断，请刷新页面或再发条消息试试",changeKf:'您可以和当前客服继续咨询或开始<a href="javascript:;" class="btn-newkf">新的咨询</a>',reReg:"网络有点问题无法接入客户，请刷新页面再试试",connect:"与服务器链接成功，请等待接入",connecting:"正在与服务器建立链接",connectError:"服务链接失败，即将自动为您重新建立链接",reconnectError:"服务链接失败，即将自动为您重新建立链接",reconnectIng:"正在重新与服务器建立链接",reconnectFail:" 当前网络有点问题，请刷新页面或再发条消息试试",calltel:"客服暂时不在线，您可直接拨打企业免费电话进行咨询",callqq:"客服暂时不在线，您可直接发起QQ会话进行咨询",wpaDisabled:"接待组件已失效",sigTtimeOut:"获取鉴权超时，请刷新页面再试试",regTimeout:"建立会话超时，请刷新页面再试试",regSuccess:"会话接入成功，开始服务",startGetSigT:"正在获取鉴权信息",sigTfail:"获取鉴权失败，请刷新页面再试试",overSumLimit:"图片数目超过最大"+Se+"张限制",msgExpired:"此消息已过期",feedBack:"感谢您的意见和建议，我们将继续努力",autoChangeKF:"原客服不在线，已为您自动更换在线的客服",noVisitorId:"无法获取访客ID，请刷新页面重试"},CHAT_MSG_TPL:{time:'<div class="msg-time"><%==timeStamp%></div>',sys:'<div class="msg-sys" data-guid="<%=seq%>">\n                    <span class="text"><%==msg%></span>\n                </div>',b2c:'<div class="msg-b2c" data-guid="<%=seq%>"><p class="avatar"><img src="<%=avatar%>"/></p><div class="content"><p class="name"><%=name%></p><div class="bubble"><p class="text"><%=data%></p></div></div></div>',b2cImage:'<div class="msg-b2c msg-image" data-guid="<%=seq%>"><p class="avatar"><img src="<%=avatar%>"/></p><div class="content"><p class="name"><%=name%></p><div class="bubble"><p class="image"><img src="<%=data%>"/></p></div></div></div>',c2b:'<div class="msg-c2b" data-guid="<%=seq%>"><div class="bubble"><i></i><p class="text"><%=data%></p></div></div>',c2bImage:'<div class="msg-c2b msg-image" data-guid="<%=seq%>"><div class="bubble"><i></i><p class="image"><img src="<%=data%>"/></p></div></div>',
calltel:'<div class="msg-offline">\n                        <div class="content">\n                            <div class="kf-detail">\n                                <p class="avatar"><img src="<%=avatar%>"/></p>\n                                <dl class="detail">\n                                    <dt><%=name%></dt>\n                                    <dd><%=corpName%><span class="resign"><%=resign%></span></dd>\n                                </dl>\n                            </div>\n                            <a href="javascript:;" class="btn-act">拨打企业免费电话</a>\n                        </div>\n                    </div>',callqq:'<div class="msg-offline">\n                        <div class="content">\n                            <div class="kf-detail">\n                                <p class="avatar"><img src="<%=avatar%>"/></p>\n                                <dl class="detail">\n                                    <dt><%=name%></dt>\n                                    <dd><%=corpName%><span class="resign"><%=resign%></span></dd>\n                                </dl>\n                            </div>\n                            <a href="javascript:;" class="btn-act">发起QQ会话</a>\n                        </div>\n                    </div>',b2cKfChange:"会话已转接到<%=o.name%>，欢迎继续咨询",msgLoad:{getMsg:'<div class="load-status"><a href="javascript:;" class="btn-load-msg"><%==text%></a></div>',loading:'<div class="load-status"><p class="status-loading"><i class="loading loading-s"></i><span class="text"><%==text%></span></p></div>',overTip:'<p class="status-tip"><span class="text"><%==text%></span></p>',numTip:'<a href="javascript:;" class="btn-offlinemsg-gotop"><%==text%>条新消息<i class="icon-arrow-up"></i></a>'},menuMsgNormal:'<div class="mod-menu <% if(o.config.welcome == 1) { %>wel<% } %><% if(o.config.menu == 1) { %>nav<% } %><% if(o.config.button == 1) { %>btn<% } %>" data-guid="<%=o.guid%>" data-oldver="<% if(o.version >= o.currentVersion) {%>0<%} else {%>1<%}%>">\n                    <div class="menu-wrap"><% if(o.version >= o.currentVersion) { %>\n                        <% if(o.config.welcome == 1) { %><div class="menu-wel">\n                            <div class="tit">\n                                <dl>\n                                    <dt><img src="<%=o.eLogo%>" width="25" height="25"/></dt>\n                                    <dd><%=o.welcome.tit%></dd>\n                                </dl>\n                            </div>\n                            <p class="text"><%=o.welcome.intro%></p>\n                        </div><% } %>\n                        <% if(o.config.menu == 1) { %><div class="menu-nav">\n                            <p class="tit"><%=o.menu.tit%></p>\n                            <% for(var i = 0, l = o.menu.list.length;i<l;i++) {%><div class="nav-item">\n                                <div class="nav-hd">\n                                    <a href="javascript:;" data-action="<%= o.menu.list[i].action%>" data-replytype="<%= o.menu.list[i].manualType || o.menu.list[i].replyType %>" data-replydata="<%=o.menu.list[i].serviceKfext || o.menu.list[i].groupId || o.menu.list[i].replyText || o.menu.list[i].imgurl || o.menu.list[i].url%>"><span class="text"><%= o.menu.list[i].name%></span> <% if(o.menu.list[i].action == 4 && o.menu.list[i].sublist) { %><i class="icon-arrow-down"><% if(o.isMobile) { %><svg><use xlink:href="#back"/></svg><% } %></i><% } %></a>\n                                </div><% if(o.menu.list[i].action == 4 && o.menu.list[i].sublist) { %>\n                                <div class="nav-bd">\n                                    <ul><% for(var k = 0, len = o.menu.list[i].sublist.length;k<len;k++) {%>\n                                        <li><a href="javascript:;" data-action="<%= o.menu.list[i].sublist[k].action%>" data-replytype="<%= o.menu.list[i].sublist[k].manualType || o.menu.list[i].sublist[k].replyType %>" data-replydata="<%= o.menu.list[i].sublist[k].serviceKfext || o.menu.list[i].sublist[k].groupId || o.menu.list[i].sublist[k].replyText || o.menu.list[i].sublist[k].imgurl || o.menu.list[i].sublist[k].url%>"><%= o.menu.list[i].sublist[k].name%></a></li><% } %>\n                                    </ul>\n                                </div><% } %>\n                            </div><% } %>\n                        </div><% } %>\n                        <% if(o.config.button == 1) { %><div class="menu-action">\n                            <ul><% for(var i = 0, l = o.button.length;i<l;i++) {%>\n                                <li style="width:<%= o.buttonWidth %>%"><a href="javascript:;" data-action="<%= o.button[i].action%>" data-replytype="<%= o.button[i].manualType || o.button[i].replyType %>" data-replydata="<%= o.button[i].serviceKfext || o.button[i].groupId || o.button[i].replyText || o.button[i].imgurl || o.button[i].url%>"><%= o.button[i].name%></a></li><% } %>\n                            </ul>\n                        </div><% } %><% } else { %>\n                        <div class="menu-disabled">\n                            <dl>\n                                <dt></dt>\n                                <dd>历史数据已失效</dd>\n                            </dl>\n                        </div><% } %>\n                    </div>\n                  </div>',menuMsgExpired:'<div class="menu-disabled">\n                            <dl>\n                                <dt></dt>\n                                <dd>历史数据已失效</dd>\n                            </dl>\n                        </div>',feedback:'<div class="mod-fb" data-fbkey=<%= o.fbKey %>>\n                            <div class="fb-wrap">\n                                <p class="tit">请对客服的服务质量进行评价</p>\n                                <div class="fb-level">\n                                    <% for(var i = 0;i < o.levelDesc.length; i++) {%><a href="javascript:;" data-desc="<%= o.levelDesc[i] %>"><% if(o.isMobile) { %><svg><use xlink:href="#star"/></svg><% } else { %><i class="icon-star"></i><% } %></a><% } %>\n                                </div><% if(o.hasDesc) {%>\n                                <div class="fb-desc">\n                                    <p class="level-desc"></p>\n                                    <div class="post-text"><p class="text"></p></div>\n                                    <div class="post-area">\n                                        <textarea maxlength="<%= o.availLetterSum %>" placeholder="感谢您的评分，可留下其他意见或建议。"></textarea>\n                                        <span class="num"><%= o.availLetterSum %></span>\n                                    </div>\n                                    <a href="javascript:;" class="btn-submit">提交</a>\n                                </div><% } %>\n                                <button class="fb-loading">正在提交评价</button>\n                            </div>\n                        </div>',blackTip:'<div class="mod-black-tip"><p class="text"><%= o.text %></p></div>'},SOCKET_CMD:{REG:{EMIT:"register",RECEIVE:"register ack"},C2B:{EMIT:"message c2b",RECEIVE:"message c2b ack"},B2C:{RECEIVE:"message b2c",EMIT:"message b2c ack"},KF_CHANGE:{EMIT:"change kf",RECEIVE:"change kf ack"},ROUTE:{RECEIVE:"route change",EMIT:"route change ack"},OVER:{RECEIVE:"session over"},SESSION_MSG:{RECEIVE:"s_msg",EMIT:"s_msg_ack"}}},Te={win:window,receptionist:{},wpaDetail:{},getSignTData:{},kfChangeTip:0,isGetSignT:0,msgSyncSum:0,isMobile:0,isChangeKF:0,inRegProcess:0,isRealSendMsg:1,isInIframe:de,defaultAvatar:be.CGI_URL.COMP_SOURCE_URL+"img/default-avatar.png",reSendC2bMsg:null,ioLinkStatus:null,regSuccessCallBack:null,imStatus:"open",pageStatus:"show",clickName:"click",chatSocket:new e,c2bDBsaveData:[],c2bSeqGroup:[],menuDetail:{active:0,currentVersion:"",eLogo:"",eName:"",defaultConfig:{active:0}},originGetSigTData:{}},ye=Te.win.navigator.userAgent.toLocaleLowerCase();Te.userAgent=ye,$.extend(Te,!0,{isGetSkin:0,serverClientTimeDiff:0});var _e={chatBody:$("body"),header:$(".title-normal"),callGroup:$(".call-group"),chatList:$(".chat-list"),modList:$(".mod-list"),chatListWrap:$(".chat-list .list-wrap"),chatPost:$(".chat-post"),chatBtnSend:$(".btn-send"),btnUpload:$(".btn-upload"),btnFace:$(".btn-face"),faceList:$(".chat-face"),uploadInput:$("input[type=file]")},we=$.extend(!0,{},_e,{page:$(".page"),chatPostArea:$(".post-area"),unReadMsgNum:$(".unread-msg-num"),statusBar:$(".title-minify")}),Ce=i(),Ie=function(){function e(e){a(Te.win,"message",function(i){n="string"==typeof i.data?JSON.parse(i.data):i.data,t("receiveMsg "+JSON.stringify(n)),"function"==typeof e?e(n):""},!1)}function i(e){var i=n?$.extend(n,e):e;i="string"!=typeof i?JSON.stringify(i):i,t("sendMsg "+i),window.top.postMessage(i,"*")}var n;return{receive:e,send:i}}(),Ee=function(e){return(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;").replace(/=/g,"&#61;").replace(/`/g,"&#96;")},Me=function(e,t){var i=/<%=(.+?)%>/g,n={}.toString;return e.replace(i,function(e,i){return"="===i.substring(0,1)?"[object Object]"==n.call(t,null)?t[i.substring(1)]:t:t[i]?Ee("[object Object]"==n.call(t,null)?t[i]:t):""})},Oe=document;if(window.isLocalStorageSupported=!1,window.localStorage&&window.localStorage.getItem)try{window.localStorage.setItem("test","test"),window.localStorage.removeItem("test"),window.isLocalStorageSupported=!0}catch(Le){}var ke,Pe={set:function(e,t){return window.isLocalStorageSupported?void window.localStorage.setItem(e,t):!1},get:function(e){var t=window.isLocalStorageSupported?window.localStorage.getItem(e):window.isLocalStorageSupported;return t?t:!1},remove:function(e){return window.isLocalStorageSupported&&window.localStorage.removeItem(e),this},clear:function(){return window.isLocalStorageSupported&&window.localStorage.clear(),this}},xe=function(){function e(e){o=Te.receptionist,t()}function t(){var e=JSON.parse(Pe.get("config")),t="kf"+o.kfUin,n=JSON.parse(Pe.get(t)),a=+new Date,s={visitorId:o.visitorId,startTime:a,total:0},r=!1;e?i():Pe.set("config",JSON.stringify({name:be.MSG_DB_OPTS.NAME,verison:be.MSG_DB_OPTS.CURRENT_VERSION,createTime:a})),n?(n.forEach(function(e){e.visitorId==s.visitorId&&(r=!0)}),r||(n.push(s),Pe.set(t,JSON.stringify(n)),r=!0)):Pe.set(t,JSON.stringify([s]))}function i(){var e,t=JSON.parse(Pe.get("config")),i=t.version||t.verison;if("1.0.0"==i&&(delete t.verison,i=1,$.extend(t,{version:1,updateAct:{name:"reName",time:+new Date}}),Pe.set("config",JSON.stringify(t))),e=be.MSG_DB_OPTS.CURRENT_VERSION-i,e>0){for(var a=0;e>a;a++)n(a);$.extend(t,{version:be.MSG_DB_OPTS.CURRENT_VERSION,updateAct:{name:"update",time:+new Date}}),Pe.set("config",JSON.stringify(t))}}function n(e){switch(e){case 0:for(var t="kf"+o.kfUin,i=JSON.parse(Pe.get(t)),n=0;n<i.length;n++){var a=i[n].visitorId,s=i[n].total;if(a==o.visitorId&&s>0)for(var r=0;s>r;r++){var c=t+"vId"+a+"index"+r,l=JSON.parse(Pe.get(c));$.extend(l,{type:1}),Pe.set(c,JSON.stringify(l))}}}}function a(e,t){var i=o.kfUin,n=o.visitorId,a=d(i,n,"get"),s="kf"+i+"vId"+n+"index"+a,r=Te.c2bDBsaveData,c={};if("b2c"==e)c={data:t.data,type:t.type,time:t.date},(1==t.type||2==t.type)&&$.extend(c,{dir:e,avatar:t.avatar,name:t.name});else{for(var l=0,u=r.length;u>l;l++){var p=r[l];if(p.seq==t.seq){$.extend(c,p,t),c.time=c.date,c.dir=e,delete c.date,delete c.seq,r.splice(l,1),Te.c2bDBsaveData=r;break}}2==c.type&&(c.data=c.imgSrc.replace(/\/0$/g,"/720"),delete c.imgSrc)}Pe.set(s,JSON.stringify(c)),a++,d(i,n,"set")}var o={};return{initialize:e,saveMsg:a}},De=xe(),Ae=[14,1,2,3,4,5,6,7,8,9,10,11,12,13,0,15,16,96,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,89,113,114,115,60,61,46,63,64,116,66,67,53,54,55,56,57,117,59,75,74,69,49,76,77,78,79,118,119,120,121,122,123,124,42,85,43,41,86,125,126,127,128,129,130,131,132,133,134,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,135,17,40,44,45,58,47,48,50,51,52,68,70,71,72,73,80,81,82,83,84,87,88,90,91,92,93,94,95,62,65],Re=["微笑","撇嘴","色","发呆","得意","流泪","害羞","闭嘴","睡","大哭","尴尬","发怒","调皮","呲牙","惊讶","难过","酷","冷汗","抓狂","吐","偷笑","可爱","白眼","傲慢","饥饿","困","惊恐","流汗","憨笑","大兵","奋斗","咒骂","疑问","嘘...","晕","折磨","衰","骷髅","敲打","再见","擦汗","抠鼻","鼓掌","糗大了","坏笑","左哼哼","右哼哼","哈欠","鄙视","委屈","快哭了","阴险","亲亲","吓","可怜","菜刀","西瓜","啤酒","篮球","乒乓","咖啡","饭","猪头","玫瑰","凋谢","示爱","爱心","心碎","蛋糕","闪电","炸弹","刀","足球","瓢虫","便便","月亮","太阳","礼物","拥抱","强","弱","握手","胜利","抱拳","勾引","拳头","差劲","爱你","NO","OK","爱情","飞吻","跳跳","发抖","怄火","转圈","磕头","回头","跳绳","挥手","激动","街舞","献吻","左太极","右太极","双喜","鞭炮","灯笼","发财","K歌","购物","邮件","帅","喝彩","祈祷","爆筋","棒棒糖","喝奶","下面","香蕉","飞机","开车","高铁左车头","车厢","高铁右车头","多云","下雨","钞票","熊猫","灯泡","风车","闹钟","大伞","彩球","钻戒","沙发","纸巾","药","手枪","青蛙"],Ge={index:Ae,humen:Re},Ue=function(e,t){var i,n,e=e?e:window.location.href;if(t){i=new RegExp("[?&]"+t+"=([^&#]*)","i");try{n=i.exec(e)[1]}catch(a){n=null}}else n=e.substring(e.indexOf("?")+1);return n},qe=[],Ne=function(){function e(e,t,i){var n={},a=0;$.ajax({url:be.CGI_URL.GET_MENU_URL,data:e,type:"POST",timeout:3e3,dataType:"json",error:function(){i.trigger("fail")},success:function(e){0!=e.r?i.trigger("fail"):($.extend(n,{config:e.data.navSet.config,eLogo:e.data.eLogo||be.CGI_URL.COMP_SOURCE_URL+"img/default-logo.png",eName:e.data.eName,version:e.data.version},e.data.navSet.content),$.extend(c,{currentVersion:parseInt(n.version),eLogo:n.eLogo,eName:n.eName}),n["default"].action&&(a=parseInt(n["default"].manualType),$.extend(c.defaultConfig,{active:parseInt(n["default"].action),roleValue:a,roleData:0===a?parseInt(n["default"].serviceKfext):parseInt(n["default"].groupId)})),$.extend(Te.menuDetail,c),l.msg(n,i))}})}function i(e){var i,n=e,o={};n.delegate("a","click",function(e){e.preventDefault(),i=$(e.currentTarget);var s=i.parent().parent(),r=s.children().eq(0),l=s.children().eq(1),d=r.find("i"),u=n.data("openIndex")||0,p=s.index();switch(o={action:parseInt(i.data("action")),type:i.data("replytype"),data:i.data("replydata")},u&&p!=u&&i.closest(".nav-hd").length&&(Te.isMobile?n.find(".nav-item").eq(u-1).children().eq(1).css("height",0).prev().find("i").removeClass("up").addClass("down"):n.find(".nav-item").eq(u-1).children().eq(1).slideUp("fast").end().find("i").removeClass("icon-arrow-up").addClass("icon-arrow-down")),o.action){case 1:Fe.normal.render("b2c",{avatar:c.eLogo,name:c.eName,data:o.data,date:+new Date,type:o.type},"autoReply",!0);break;case 2:y(o.data);break;case 3:Te.inRegProcess||($.extend(Te.getSignTData,{kfuin:a.kfUin,roleValue:o.type,roleData:o.data}),delete Te.wpaDetail.extUin,F(Te.getSignTData,null,null,!0));break;case 4:Te.isMobile?"0px"==l.css("height")?(n.data("openIndex",p),d.addClass("up"),l.css("height",46*l.find("li").length+"px")):(n.removeData("openIndex"),d.removeClass("up"),l.css("height","0px")):(l.css("display")&&"none"!=l.css("display")?(d.removeClass("icon-arrow-up").addClass("icon-arrow-down"),n.removeData("openIndex")):(d.removeClass("icon-arrow-down").addClass("icon-arrow-up"),n.data("openIndex",p)),l.slideToggle("fast"));break;default:t("data error")}}),n.on("expired",function(){$(this).attr("data-oldver",1).addClass("menu-expired").children().append(be.CHAT_MSG_TPL.menuMsgExpired)})}var a=Te.receptionist,r=Te.wpaDetail,c=Te.menuDetail,l=(Te.inRegProcess,Te.chatSocket,{start:function(t,i){var n={visitorId:a.visitorId,wpaId:r.wpaId,kfuin:a.kfUin,navKey:t.menuKey},o={loading:be.VIEW_OPTS.MENU_MSG.LOADING,fail:be.VIEW_OPTS.MENU_MSG.FAIL},c=e;t.isNewNav&&(s({type:"msgExpired",act:"new"}),this.expired()),this.load(null,n,o,c)},load:function(e,t,i,a){var o=$(Me(be.CHAT_MSG_TPL.msgLoad.loading,i.loading)),s=$('[data-guid="'+e+'"]').prev();o.data("queryData",t),e?o.insertBefore(s):_e.chatListWrap.append(o),s=o,o.on("fail",function(){o.html(Me(be.CHAT_MSG_TPL.msgLoad.getMsg,i.fail)).find(".btn-load-msg").one(Te.clickName,function(){o.trigger("loading"),a&&a(t,s,o)}),n()}).on("loading",function(){o.html(Me(be.CHAT_MSG_TPL.msgLoad.loading,i.loading))}).on("success",function(){o.remove()}).on("over",function(){o.html(Me(be.CHAT_MSG_TPL.msgLoad.overTip,i.over))}),a&&a(t,s,o)},expired:function(){_e.chatListWrap.find('.mod-menu[data-oldver="0"]').each(function(){$(this).trigger("expired")})},msg:function(e,t){var a=0,s=+new Date;e.button&&(a=(100/e.button.length).toFixed(2),$.extend(e,{buttonWidth:a})),De.saveMsg("b2c",{data:e,type:3,date:s}),$.extend(e,{isMobile:Te.isMobile,currentVersion:c.currentVersion,guid:o(be.SOCKET_OPTS.SEQ_RANGE.C2B_FOR_PHP)}),T(s),_e.chatListWrap.append($.tmpl(be.CHAT_MSG_TPL.menuMsgNormal,e)),t.trigger("success"),n(),i($('[data-guid="'+e.guid+'"]'))}});return{render:l,bindEvents:i}},$e={get:function(e){var t="kf"+e.kfUin+"vId"+e.visitorId+"red",i=JSON.parse(Pe.get(t)),n="wId"+e.wpaId,a={};return i&&i.forEach(function(e){e[n]&&(a=e[n])}),a},set:function(e,t,i){var n,a=arguments.length<=3||void 0===arguments[3]?!0:arguments[3],o="kf"+e.kfUin+"vId"+e.visitorId+"red",t="wId"+t,s=JSON.parse(Pe.get(o)),r=!1,c={name:e.name,number:1},l={},d=c.number;s?(s.forEach(function(i){for(n in i)n==t&&(r=!0,d=i[n].number+1,i[n].number=d,i[n].name=e.name)}),r||(l[t]=c,s.push(l)),a&&Pe.set(o,JSON.stringify(s))):(l[t]=c,Pe.set(o,JSON.stringify([l]))),!Te.isMobile&&$e.render("update",d),i&&i(d)},reset:function(e){var t,i="kf"+e.kfUin+"vId"+e.visitorId+"red",n=JSON.parse(Pe.get(i)),a=[];n&&(n.forEach(function(e){for(t in e){var i={};i[t]={number:0},a.push(i)}}),Pe.set(i,JSON.stringify(a)))},render:function(e,t,i){var n={page:$(".page"),unReadMsgNum:$(".unread-msg-num")},a=n.unReadMsgNum.parent().find(".name"),o=n.unReadMsgNum.parent().find(".status");0!=t&&("update"==e?(n.unReadMsgNum.hasClass("hidden")&&n.unReadMsgNum.removeClass("hidden"),n.unReadMsgNum.text(t>9?"9+":t)):"reset"==e&&n.unReadMsgNum.addClass("hidden").text(""),i&&(n.page.removeClass("page-inframe").addClass("page-minify"),a.text(i.name),o.text(i.status)))}},He=[],Fe={historyMsg:L(),normal:k(),image:P(),renderUploadImgRet:C},Be=(function(){var e=i(),t=0;return"iOS"==e&&window.navigator.appVersion.match(/OS(.*?)like/i)&&(t=parseInt(window.navigator.appVersion.match(/OS(.*?)like/i)[1].trim(),10)),t}(),function(){function e(e,t,i){$.ajax({url:be.CGI_URL.GET_OFFLINE_MSG,data:e,type:"POST",timeout:3e3,dataType:"json",error:function(){i.trigger("fail")},success:function(e){"undefined"!=typeof e&&"undefined"!=typeof e.code&&0==e.code?o.msg(e,t,i):i.trigger("fail")}})}var i=Te.receptionist,a=(Te.wpaDetail,Te.mobileSysType),o={load:function(t,a){var o=$(Me(be.CHAT_MSG_TPL.msgLoad.loading,be.VIEW_OPTS.OFFLINE_MSG.LOADING)),s=t.body.offlineMsgNum,r=(be.VIEW_OPTS.OFFLINE_MSG.PER_NUM,{visitorId:i.visitorId,kfext:t.body.offlineUin,kfuin:i.kfUin,key:t.body.offlineMsgKey,start:0,num:s}),c=$('[data-guid="'+a+'"]').prev();o.data("queryData",r),a?o.insertBefore(c):_e.chatListWrap.append(o),c=o,o.on("fail",function(){o.html(Me(be.CHAT_MSG_TPL.msgLoad.getMsg,be.VIEW_OPTS.OFFLINE_MSG.FAIL)).find(".btn-load-msg").one(Te.clickName,function(){o.trigger("loading"),e(r,c,o)}),n()}).on("loading",function(){o.html(Me(be.CHAT_MSG_TPL.msgLoad.loading,be.VIEW_OPTS.OFFLINE_MSG.LOADING))}).on("over",function(){o.html(Me(be.CHAT_MSG_TPL.msgLoad.overTip,be.VIEW_OPTS.OFFLINE_MSG.OVER))}),e(r,c,o)},msg:function(e,i,o){for(var s,r=this,c=e.rowDatas,l=o.data("queryData"),d={},u=c.length-1;u>=0;u--)$.extend(d,c[u],{avatar:e.kfInfo.face,name:e.kfInfo.name}),Fe.normal.conventSigle("b2c",d).insertAfter(i),$(Me(be.CHAT_MSG_TPL.time,b(d.date))).insertAfter(i),De.saveMsg("b2c",d);o.trigger("over"),n(),o[0].getBoundingClientRect().top<45&&(t("第一条离线消息没有看到"),s="Android"==a?_e.modList:_e.chatListWrap,r.tip(l.num,"show",o[0].offsetTop),s.on("scroll",function(){o[0].getBoundingClientRect().top>=45&&(r.tip(l.num,"hide"),s.off("scroll"))}))},tip:function(e,t,i){var n=$(Me(be.CHAT_MSG_TPL.msgLoad.numTip,e));_e.chatList.append(n),"hide"==t?_e.chatList.find(".btn-offlinemsg-gotop").remove():n.on(Te.clickName,function(){_e.chatListWrap[0].scrollTop=i,n.remove()})}};return{render:o}}()),We=function(){function e(e){$.extend(o,e),t()}function t(){var e=o.data;e.fbKey;d.emitMsg(be.SOCKET_CMD.SESSION_MSG.EMIT,{csrf:o.csrf,seq:o.seq,type:o.type,time:o.time}),$.extend(e,{hasDesc:2==e.style?!0:!1,isMobile:Te.isMobile},be.FB_OPTS),_e.chatListWrap.append($.tmpl(be.CHAT_MSG_TPL.feedback,e)),n(),i(e)}function i(e){var t,i,n,o=e.hasDesc,r=e.fbKey,c={avail:be.FB_OPTS.availLetterSum,used:0,remain:be.FB_OPTS.availLetterSum},d={},u=0,f=0,g=be.FB_OPTS.delayTime,h=$('[data-fbkey="'+r+'"]'),m=h.find(".fb-level a"),v=h.find(".fb-desc"),S=h.find(".post-text").children().eq(0),b=h.find(".fb-loading");h.data("extUin",e.extUin),Object.defineProperty(d,"seq",{value:e.seq}),Object.defineProperty(d,"level",{set:function(e){var t=e+1;h.data("level",t).find(".level-desc").text(m.eq(e).data("desc")),!o&&h.trigger("loading")},get:function(){return h.data("level")}}),Object.defineProperty(d,"desc",{set:function(e){f=1,h.data("desc",e).trigger("loading")},get:function(){return h.data("desc")}}),!l&&m.hover(function(){for(var e=0;e<=$(this).index();e++)m.eq(e).addClass("on")},function(){for(var e=0;e<=$(this).index();e++)m.eq(e).removeClass("on")}),m.on(Te.clickName,function(){if(!$(this).parent().hasClass("disabled")){u=$(this).index(),d.level=u,m.removeClass("active");for(var e=0;u>=e;e++)m.eq(e).addClass("active");o&&0!=v.length&&"none"==v.css("display")&&(i=h.find(".num").eq(0),n=h.find(".btn-submit").eq(0),t=v.find("textarea").eq(0),v[l?"show":"slideDown"]("fast"),t.on("input keyup",function(e){var t=$(this).val();c.used=$(this).val().length,c.remain=c.avail-c.used,i.text(c.remain),c.remain<=0&&(i.text(0),$(this).val(t.substring(0,c.avail)),e.preventDefault())}),n.on(Te.clickName,function(){var e=$.trim(t.val());f||(d.desc=e,S.text(e))}))}}),h.on("loading",function(){b.fadeIn("fast"),a(d,h)}).on("success",function(){p({text:"提交成功"},g,function(){b.fadeOut("fast"),m.parent().addClass("disabled"),o&&(n.hide().prev().hide(),S.text().length>0&&S.parent().show()),s({type:"feedBack",act:"new"})})}).on("fail",function(e,t){f=0,p({text:"提交失败："+t},g,function(){b.fadeOut("fast")})})}function a(e,t){var e=$.extend({},{fbLevel:e.level,fbDesc:e.desc,seq:e.seq,fbKey:t.data("fbkey"),visitorId:r.visitorId,kfuin:r.kfUin,extUin:t.data("extUin"),wpaId:c.wpaId,session_time:r.time});$.ajax({url:be.CGI_URL.GET_FEEDBACK_RET,data:e,type:"POST",timeout:3e3,dataType:"json",error:function(){t.trigger("fail","网络错误，请重试")},success:function(e){0!=e.r?t.trigger("fail",e.message):t.trigger("success")}})}var o={},r=Te.receptionist,c=Te.wpaDetail,l=Te.isMobile,d=Te.chatSocket;return{initialize:e}},Ke=Te.chatSocket,Ve=function(){function e(e,t){var n,a={visitorId:c.visitorId,isMobile:Te.isMobile,wpaKey:d.wpaKey,reception:d.reception,signT:e,kfuin:c.kfUin,qqUin:l(),wpaId:d.wpaId,key:d.key,invitationType:d.invitationType,extUin:d.extUin,roleValue:p.roleValue,roleData:p.roleData,isChangeKF:Te.isChangeKF};Te.inRegProcess;u.currentVersion&&$.extend(a,{navVersion:u.currentVersion});for(n in a)"undefined"==typeof a[n]&&delete a[n];$.extend(a,{clickid:d.clickid}),i(a)}function t(e,t){var i=3*(be.SOCKET_OPTS.OPTS.ReconnectionAttempts+1)-1;e=t>=i?"reconnectFail":e,s({type:e,seq:Te.inRegProcess,act:"update"}),_e.chatBody.hasClass("regsuccess")&&"reconnectFail"==e&&_e.chatListWrap.find("loading").remove()}function i(e){var i,a={query:"kfuin="+c.kfUin},o=0;$.extend(a,Te.isMobile?{transports:["websocket"]}:{}),i=g.create(be.CGI_URL.SOCKET_CHAT,$.extend(be.SOCKET_OPTS.OPTS,a)),i.emitMsg(be.SOCKET_CMD.REG.EMIT,e,function(){setTimeout(function(){h||s({type:"regTimeout",empty:!0})},be.SOCKET_OPTS.REG_TIMEOUT)},this).receiveMsg(be.SOCKET_CMD.REG.RECEIVE,n,this,null,!0),i.ioLink.once("connect_error",function(e){o++,t("connectError",o)}),i.ioLink.once("reconnecting",function(e){o++,t("reconnectIng",o)}),i.ioLink.once("reconnect_error",function(e){o++,t("reconnectError",o)}),i.ioLink.once("reconnect_failed",function(e){o++,Te.ioLinkStatus="over",t("reconnectFail",o)}),i.ioLink.once("connect",function(e){o=0,Te.ioLinkStatus="normal",t("connect")})}function n(e){h=1,"success"==e.result?a(e):o(e)}function a(e){Te.ioLinkStatus="normal",De.initialize({receptionist:c}),delete Te.wpaDetail.extUin,$.extend(c,{corpName:e.body.c_info.name,extUin:e.body.u_info.uin,name:e.body.u_info.name,avatar:e.body.u_info.face||Te.defaultAvatar,resign:e.body.u_info.position,qq:e.body.u_info.qq,time:e.body.time}),q(),_e.chatBody.hasClass("regsuccess")||Te.regSuccessCallBack&&Te.regSuccessCallBack(),e.body.update&&s({type:"autoChangeKF",act:"new"}),s({type:"regSuccess",act:"update",seq:Te.inRegProcess}),Te.inRegProcess=0,D(e),Te.isChangeKF="undefined"!=typeof e.body.isChangeKF?e.body.isChangeKF:0,Te.isChangeKF&&(_e.chatListWrap.find(".btn-newkf").addClass("disabled"),s({type:"changeKf",seq:Te.inRegProcess,act:"new"}),$(".msg-sys .btn-newkf").on(Te.clickName,function(t){N(e,t)})),Te.reSendC2bMsg&&v("c2b",Te.reSendC2bMsg,"msg"),$.extend(Te.receptionist,c)}function o(e){var t=e.errmsg||be.SYS_MSG.reReg;s({msgType:"serverResp",seq:f,act:"update",data:t}),Te.inRegProcess=0}function r(){"sessionOver"!=Te.ioLinkStatus||Te.isChangeKF||(p=Te.originGetSigTData,delete Te.wpaDetail.extUin,delete Te.menuDetail.currentVersion),Te.isGetSignT=0,h=0,Te.isInIframe?Ie.send({act:"SMS_SM_FORCE_CONNECT"}):window.__STATUS_MANAGER.forceConnect(),F(p)}var c=Te.receptionist,d=Te.wpaDetail,u=Te.menuDetail,p=Te.getSignTData,f=(Te.kfChangeTip,Te.localClickId,Te.inRegProcess),g=Te.chatSocket,h=0;return{prepareRegData:e,reConnect:r}},je=$.extend(!0,{},be,{CGI_URL:{GET_SKIN_CORP_INFO:"https://"+__domain.admin+".qidian.qq.com/webim/innerPage/getPCIMInfo"},CHAT_MSG_TPL:{corpInfo:'<div class="mod-desc">\n                    <p class="logo"><img src="<%=o.eLogo%>" width="100" alt="<%=o.eName%>" title="<%=o.eName%>" height="100"/></p>\n                    <p class="name"><%=o.eName%></p>\n                    <div class="desc"><%=o.eDesc%></div>\n                </div>\n                <div class="mod-connect">\n                    <ul>\n                        <% if(o.eAddressDetail) { %><li title="<%=o.eAddressDetail%>"><i class="icon-address"></i><%=o.eAddressDetail%></li><% } %>\n                        <% if(o.eEmail) { %><li><i class="icon-email"></i><a href="mailto:<%=o.eEmail%>" title="<%=o.eEmail%>"><%=o.eEmail%></a></li><% } %>\n                        <% if(o.eHome) { %><li><i class="icon-link"></i><a href="<%=o.eHome%>"  title="<%=o.eHome%>" target="_blank"><%=o.eHome%></a></li><% } %>\n                        <% if(o.ePhone) { %><li><i class="icon-tel"></i><a href="tel:<%=o.ePhone%>" title="<%=o.ePhone%>"><%=o.ePhone%></a></li><% } %>\n                    </ul>\n                </div>'}}),Qe=function(){function e(e){$.ajax({url:je.CGI_URL.GET_SKIN_CORP_INFO,data:e,type:"POST",timeout:3e3,dataType:"json",error:function(){t.fail()},success:function(e){Te.isGetSkin=1,t[e.code?"fail":"success"](e)}})}var t={success:function(e){var t,i=["blue","default","orange","red","green"],n="skin-default",a="skin-"+i[e.theme];"undefined"!=typeof e.corpInfo.eLogo&&0!=e.corpInfo.eLogo&&e.corpInfo.eLogo||(e.corpInfo.eLogo=je.CGI_URL.COMP_SOURCE_URL+"img/default-logo.png"),t=$.tmpl(je.CHAT_MSG_TPL.corpInfo,e.corpInfo),a!=n&&we.page.removeClass(n).addClass(a),t&&$(".sidebar").html(t)},fail:function(e){$(".sidebar").find("i").remove().end().find(".text").html("企业信息拉取失败")}};return{getData:e}},Je=B(),Ye="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(e,t,i){var n,a,o,s,r,c,l,d,u,p,f,g,h,m,v,S,b,T,y,_,w,C,I,E,M,O,L,k,P,x;C={paneClass:"nano-pane",sliderClass:"nano-slider",contentClass:"nano-content",enabledClass:"has-scrollbar",flashedClass:"flashed",activeClass:"active",iOSNativeScrolling:!1,preventPageScrolling:!1,disableResize:!1,alwaysVisible:!1,flashDelay:1500,sliderMinHeight:20,sliderMaxHeight:null,documentContext:null,windowContext:null},b="scrollbar",S="scroll",d="mousedown",u="mouseenter",p="mousemove",g="mousewheel",f="mouseup",v="resize",s="drag",r="enter",y="up",m="panedown",a="DOMMouseScroll",o="down",_="wheel",c="keydown",l="keyup",T="touchmove",n=null,O=t.requestAnimationFrame,w=t.cancelAnimationFrame,k=i.createElement("div").style,x=function(){var e,t,i,n,a,o;for(n=["t","webkitT","MozT","msT","OT"],e=a=0,o=n.length;o>a;e=++a)if(i=n[e],t=n[e]+"ransform",t in k)return n[e].substr(0,n[e].length-1);return!1}(),P=function(e){return x===!1?!1:""===x?e:x+e.charAt(0).toUpperCase()+e.substr(1)},L=P("transform"),E=L!==!1,I=function(){var e,t,n;return e=i.createElement("div"),t=e.style,t.position="absolute",t.width="100px",t.height="100px",t.overflow=S,t.top="-9999px",i.body.appendChild(e),n=e.offsetWidth-e.clientWidth,i.body.removeChild(e),n},M=function(){var e,i,n;return i=t.navigator.userAgent,(e=/(?=.+Mac OS X)(?=.+Firefox)/.test(i))?(n=/Firefox\/\d{2}\./.exec(i),n&&(n=n[0].replace(/\D+/g,"")),e&&+n>23):!1},h=function(){function c(a,o){this.el=a,this.options=o,n||(n=I()),this.$el=e(this.el),this.doc=e(this.options.documentContext||i),this.win=e(this.options.windowContext||t),this.body=this.doc.find("body"),this.$content=this.$el.children("."+this.options.contentClass),this.$content.attr("tabindex",this.options.tabIndex||0),this.content=this.$content[0],this.previousPosition=0,this.options.iOSNativeScrolling&&null!=this.el.style.WebkitOverflowScrolling?this.nativeScrolling():this.generate(),this.createEvents(),this.addEvents(),this.reset()}return c.prototype.preventScrolling=function(e,t){if(this.isActive)if(e.type===a)(t===o&&e.originalEvent.detail>0||t===y&&e.originalEvent.detail<0)&&e.preventDefault();else if(e.type===g){if(!e.originalEvent||!e.originalEvent.wheelDelta)return;(t===o&&e.originalEvent.wheelDelta<0||t===y&&e.originalEvent.wheelDelta>0)&&e.preventDefault()}},c.prototype.nativeScrolling=function(){this.$content.css({WebkitOverflowScrolling:"touch"}),this.iOSNativeScrolling=!0,this.isActive=!0},c.prototype.updateScrollValues=function(){var e,t;e=this.content,this.maxScrollTop=e.scrollHeight-e.clientHeight,this.prevScrollTop=this.contentScrollTop||0,this.contentScrollTop=e.scrollTop,t=this.contentScrollTop>this.previousPosition?"down":this.contentScrollTop<this.previousPosition?"up":"same",this.previousPosition=this.contentScrollTop,"same"!==t&&this.$el.trigger("update",{position:this.contentScrollTop,maximum:this.maxScrollTop,direction:t}),this.iOSNativeScrolling||(this.maxSliderTop=this.paneHeight-this.sliderHeight,this.sliderTop=0===this.maxScrollTop?0:this.contentScrollTop*this.maxSliderTop/this.maxScrollTop)},c.prototype.setOnScrollStyles=function(){var e;E?(e={},e[L]="translate(0, "+this.sliderTop+"px)"):e={top:this.sliderTop},O?(w&&this.scrollRAF&&w(this.scrollRAF),this.scrollRAF=O(function(t){return function(){return t.scrollRAF=null,t.slider.css(e)}}(this))):this.slider.css(e)},c.prototype.createEvents=function(){this.events={down:function(e){return function(t){return e.isBeingDragged=!0,e.offsetY=t.pageY-e.slider.offset().top,e.slider.is(t.target)||(e.offsetY=0),e.pane.addClass(e.options.activeClass),e.doc.bind(p,e.events[s]).bind(f,e.events[y]),e.body.bind(u,e.events[r]),!1}}(this),drag:function(e){return function(t){return e.sliderY=t.pageY-e.$el.offset().top-e.paneTop-(e.offsetY||.5*e.sliderHeight),e.scroll(),e.contentScrollTop>=e.maxScrollTop&&e.prevScrollTop!==e.maxScrollTop?e.$el.trigger("scrollend"):0===e.contentScrollTop&&0!==e.prevScrollTop&&e.$el.trigger("scrolltop"),!1}}(this),up:function(e){return function(t){return e.isBeingDragged=!1,e.pane.removeClass(e.options.activeClass),e.doc.unbind(p,e.events[s]).unbind(f,e.events[y]),e.body.unbind(u,e.events[r]),!1}}(this),resize:function(e){return function(t){e.reset()}}(this),panedown:function(e){return function(t){return e.sliderY=(t.offsetY||t.originalEvent.layerY)-.5*e.sliderHeight,e.scroll(),
e.events.down(t),!1}}(this),scroll:function(e){return function(t){e.updateScrollValues(),e.isBeingDragged||(e.iOSNativeScrolling||(e.sliderY=e.sliderTop,e.setOnScrollStyles()),null!=t&&(e.contentScrollTop>=e.maxScrollTop?(e.options.preventPageScrolling&&e.preventScrolling(t,o),e.prevScrollTop!==e.maxScrollTop&&e.$el.trigger("scrollend")):0===e.contentScrollTop&&(e.options.preventPageScrolling&&e.preventScrolling(t,y),0!==e.prevScrollTop&&e.$el.trigger("scrolltop"))))}}(this),wheel:function(e){return function(t){var i;if(null!=t)return i=t.delta||t.wheelDelta||t.originalEvent&&t.originalEvent.wheelDelta||-t.detail||t.originalEvent&&-t.originalEvent.detail,i&&(e.sliderY+=-i/3),e.scroll(),!1}}(this),enter:function(e){return function(t){var i;if(e.isBeingDragged)return 1!==(t.buttons||t.which)?(i=e.events)[y].apply(i,arguments):void 0}}(this)}},c.prototype.addEvents=function(){var e;this.removeEvents(),e=this.events,this.options.disableResize||this.win.bind(v,e[v]),this.iOSNativeScrolling||(this.slider.bind(d,e[o]),this.pane.bind(d,e[m]).bind(""+g+" "+a,e[_])),this.$content.bind(""+S+" "+g+" "+a+" "+T,e[S])},c.prototype.removeEvents=function(){var e;e=this.events,this.win.unbind(v,e[v]),this.iOSNativeScrolling||(this.slider.unbind(),this.pane.unbind()),this.$content.unbind(""+S+" "+g+" "+a+" "+T,e[S])},c.prototype.generate=function(){var e,i,a,o,s,r,c;return o=this.options,r=o.paneClass,c=o.sliderClass,e=o.contentClass,(s=this.$el.children("."+r)).length||s.children("."+c).length||this.$el.append('<div class="'+r+'"><div class="'+c+'" /></div>'),this.pane=this.$el.children("."+r),this.slider=this.pane.find("."+c),0===n&&M()?(a=t.getComputedStyle(this.content,null).getPropertyValue("padding-right").replace(/[^0-9.]+/g,""),i={right:-14,paddingRight:+a+14}):n&&(i={right:-n},this.$el.addClass(o.enabledClass)),null!=i&&this.$content.css(i),this},c.prototype.restore=function(){this.stopped=!1,this.iOSNativeScrolling||this.pane.show(),this.addEvents()},c.prototype.reset=function(){var e,t,i,a,o,s,r,c,l,d,u,p;return this.iOSNativeScrolling?void(this.contentHeight=this.content.scrollHeight):(this.$el.find("."+this.options.paneClass).length||this.generate().stop(),this.stopped&&this.restore(),e=this.content,a=e.style,o=a.overflowY,t=e.scrollHeight+n,d=parseInt(this.$el.css("max-height"),10),d>0&&(this.$el.height(""),this.$el.height(e.scrollHeight>d?d:e.scrollHeight)),r=this.pane.outerHeight(!1),l=parseInt(this.pane.css("top"),10),s=parseInt(this.pane.css("bottom"),10),c=r+l+s,p=Math.round(c/t*r),p<this.options.sliderMinHeight?p=this.options.sliderMinHeight:null!=this.options.sliderMaxHeight&&p>this.options.sliderMaxHeight&&(p=this.options.sliderMaxHeight),o===S&&a.overflowX!==S&&(p+=n),this.maxSliderTop=c-p,this.contentHeight=t,this.paneHeight=r,this.paneOuterHeight=c,this.sliderHeight=p,this.paneTop=l,this.slider.height(p),this.events.scroll(),this.pane.show(),this.isActive=!0,e.scrollHeight===e.clientHeight||this.pane.outerHeight(!0)>=e.scrollHeight&&o!==S?(this.pane.hide(),this.isActive=!1):this.el.clientHeight===e.scrollHeight&&o===S?this.slider.hide():this.slider.show(),this.pane.css({opacity:this.options.alwaysVisible?1:"",visibility:this.options.alwaysVisible?"visible":""}),i=this.$content.css("position"),("static"===i||"relative"===i)&&(u=parseInt(this.$content.css("right"),10),u&&this.$content.css({right:"",marginRight:u})),this)},c.prototype.scroll=function(){return this.isActive?(this.sliderY=Math.max(0,this.sliderY),this.sliderY=Math.min(this.maxSliderTop,this.sliderY),this.$content.scrollTop(this.maxScrollTop*this.sliderY/this.maxSliderTop),this.iOSNativeScrolling||(this.updateScrollValues(),this.setOnScrollStyles()),this):void 0},c.prototype.scrollBottom=function(e){return this.isActive?(this.$content.scrollTop(this.contentHeight-this.$content.height()-e).trigger(g),this.stop().restore(),this):void 0},c.prototype.scrollTop=function(e){return this.isActive?(this.$content.scrollTop(+e).trigger(g),this.stop().restore(),this):void 0},c.prototype.scrollTo=function(e){return this.isActive?(this.scrollTop(this.$el.find(e).get(0).offsetTop),this):void 0},c.prototype.stop=function(){return w&&this.scrollRAF&&(w(this.scrollRAF),this.scrollRAF=null),this.stopped=!0,this.removeEvents(),this.iOSNativeScrolling||this.pane.hide(),this},c.prototype.destroy=function(){return this.stopped||this.stop(),!this.iOSNativeScrolling&&this.pane.length&&this.pane.remove(),this.$content.removeAttr("tabindex"),this.$el.hasClass(this.options.enabledClass)&&(this.$el.removeClass(this.options.enabledClass),this.$content.css({right:""})),this},c.prototype.flash=function(){return!this.iOSNativeScrolling&&this.isActive?(this.reset(),this.pane.addClass(this.options.flashedClass),setTimeout(function(e){return function(){e.pane.removeClass(e.options.flashedClass)}}(this),this.options.flashDelay),this):void 0},c}(),e.fn.nanoScroller=function(t){return this.each(function(){var i,n;if((n=this.nanoscroller)||(i=e.extend({},C,t),this.nanoscroller=n=new h(this,i)),t&&"object"===("undefined"==typeof t?"undefined":Ye(t))){if(e.extend(n.options,t),null!=t.scrollBottom)return n.scrollBottom(t.scrollBottom);if(null!=t.scrollTop)return n.scrollTop(t.scrollTop);if(t.scrollTo)return n.scrollTo(t.scrollTo);if("bottom"===t.scroll)return n.scrollBottom(0);if("top"===t.scroll)return n.scrollTop(0);if(t.scroll&&t.scroll instanceof e)return n.scrollTo(t.scroll);if(t.stop)return n.stop();if(t.destroy)return n.destroy();if(t.flash)return n.flash()}return n.reset()})},e.fn.nanoScroller.Constructor=h}(jQuery,window,document);var ze={get:j,set:Q},Xe=function(){function e(){var e,i=we.faceList.find("ul"),n={sum:140,listWidth:Te.win.innerWidth-20,rowSum:7};if(0==i.children().length){for(var a=0;a<n.sum;a++)e=$('<li title="'+Ge.humen[a]+'" data-index="['+Ge.humen[a]+']"></li>'),i.append(e);$(".nano").nanoScroller(),t()}}function t(){we.faceList.on("click","li",function(e){var t=$(e.currentTarget),i=t.data("index"),n=i.length,a=we.chatPostArea.val(),o=a.length,s=ze.get(we.chatPostArea[0]);we.faceList.trigger("hide"),a=o?a.substring(0,s)+i+a.substr(s,o):i,we.chatPostArea.val(a),s+=n,ze.set(we.chatPostArea[0],s)})}return{render:e}}();!function(e){var t,i=e.Uint8Array,n=e.HTMLCanvasElement,a=n&&n.prototype,o=/\s*;\s*base64\s*(?:;|$)/i,s="toDataURL",r=function(e){for(var n,a,o,s=e.length,r=new i(s/4*3|0),c=0,l=0,d=[0,0],u=0,p=0;s--;)a=e.charCodeAt(c++),n=t[a-43],255!==n&&n!==o&&(d[1]=d[0],d[0]=a,p=p<<6|n,u++,4===u&&(r[l++]=p>>>16,61!==d[1]&&(r[l++]=p>>>8),61!==d[0]&&(r[l++]=p),u=0));return r};i&&(t=new i([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51])),!n||a.toBlob&&a.toBlobHD||(a.toBlob||(a.toBlob=function(e,t){if(t||(t="image/png"),this.mozGetAsFile)return void e(this.mozGetAsFile("canvas",t));if(this.msToBlob&&/^\s*image\/png\s*(?:$|;)/i.test(t))return void e(this.msToBlob());var n,a=Array.prototype.slice.call(arguments,1),c=this[s].apply(this,a),l=c.indexOf(","),d=c.substring(l+1),u=o.test(c.substring(0,l));Blob.fake?(n=new Blob,u?n.encoding="base64":n.encoding="URI",n.data=d,n.size=d.length):i&&(n=u?new Blob([r(d)],{type:t}):new Blob([decodeURIComponent(d)],{type:t})),e(n)}),!a.toBlobHD&&a.toDataURLHD?a.toBlobHD=function(){s="toDataURLHD";var e=this.toBlob();return s="toDataURL",e}:a.toBlobHD=a.toBlob)}(window),ee.prototype.initialize=function(){var e=this,t=this.options.$trigger,i=this.options.triggerEvent||"click",n=this.options.isNeedWifiTip,a=this.options.initializeCallBack;t.off(i).on(i,function(){e[n?"wifiTip":"bindUploadEvent"](),"function"==typeof a?a():""})},ee.prototype.wifiTip=function(){var e;Z()?this.bindUploadEvent():(e=window.sessionStorage.getItem("wifiTip"),e?this.bindUploadEvent():X("请注意：非wifi网络下发送图片可能会耗费较多流量",function(){window.sessionStorage.setItem("wifiTip","1"),this.bindUploadEvent()},this))},ee.prototype.bindUploadEvent=function(){var e=this,t=this.options.$inputTrigger;t.trigger("click"),t.off("change").on("change",function(i){e.checkImgFilesLen(this.files),t.prop("value","")})},ee.prototype.checkImgFilesLen=function(e){var t=e.length;return t>be.IMG_UPLOAD_OPTS.MAX_SUM?void this.renderSysMsg({type:"overSumLimit"}):void this.checkImgTypeLocal(e)},ee.prototype.checkImgTypeLocal=function(e){for(var t,i={},n=0,a=e.length;a>n;n++){var s=e[n];t=window.URL.createObjectURL(s),i=$.extend(!0,{},{seq:o(be.SOCKET_OPTS.SEQ_RANGE.C2B_FOR_PHP),type:s.type,size:s.size,blobUrl:t,content:s}),-1!=$.inArray(s.type,be.IMG_UPLOAD_OPTS.ACCEPT_TYPE)?(this.options.events.preview(i),this.compressImgFiles(i)):this.options.events.preview(i,"notSupport")}},ee.prototype.compressImgFiles=function(e){var t=e.type;switch(t){case"image/jpeg":this.compressJPGImg(e);break;case"image/jpg":this.compressJPGImg(e);break;case"image/png":this.compressPNGImg(e);break;default:this.options.events.replacePlaceholder(e)}},ee.prototype.compressJPGImg=function(e){var t,i=this,n=new Image,a=document.createElement("canvas"),o=a.getContext("2d");n.src=e.blobUrl,n.onload=function(){t={width:n.naturalWidth,height:n.naturalHeight},a.width=t.width,a.height=t.height,o.drawImage(n,0,0,t.width,t.height,0,0,t.width,t.height);a.toBlob(function(t){e.content=t,e.size=t.size,i.options.events.replacePlaceholder(e)},e.type,be.IMG_UPLOAD_OPTS.JPG_COMPRESS_RATIO/100)}},ee.prototype.compressPNGImg=function(e){var t,i,n,a=this,o=new Image,s=document.createElement("canvas"),r=s.getContext("2d");o.src=e.blobUrl,o.onload=function(){if(t={width:o.naturalWidth,height:o.naturalHeight},!(t.width>be.IMG_UPLOAD_OPTS.MAX_WIDTH||t.height>be.IMG_UPLOAD_OPTS.MAX_HEIGHT))return void a.options.events.replacePlaceholder(e);i=Math.floor(t.width*(be.IMG_UPLOAD_OPTS.MAX_HEIGHT/t.height)),n=Math.floor(t.height*(be.IMG_UPLOAD_OPTS.MAX_WIDTH/t.width)),i>be.IMG_UPLOAD_OPTS.MAX_WIDTH?i=be.IMG_UPLOAD_OPTS.MAX_WIDTH:n>be.IMG_UPLOAD_OPTS.MAX_HEIGHT&&(n=be.IMG_UPLOAD_OPTS.MAX_HEIGHT),s.width=i,s.height=n,r.drawImage(o,0,0,t.width,t.height,0,0,i,n);s.toBlob(function(t){e.content=t,e.size=t.size,a.options.events.replacePlaceholder(e)},e.type)}};var Ze=ve();Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var i,n;if(null==this)throw new TypeError(" this is null or not defined");var a=Object(this),o=a.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(i=t),n=0;o>n;){var s;n in a&&(s=a[n],e.call(i,s,n,a)),n++}});var et=function(){function e(e){var n,a="kf"+i.kfUin,o=JSON.parse(Pe.get(a)),s=Te.msgSyncSum;o&&o.forEach(function(e){e.visitorId==i.visitorId&&(s?e.total>s&&(n=e.total-s,t(n,e.total)):Te.msgSyncSum=e.total)})}function t(e,t){for(var a,o,s=i.kfUin,r=i.visitorId,c=t-e,l=c;t>l;l++)a="kf"+s+"vId"+r+"index"+l,o=JSON.parse(Pe.get(a)),Fe.historyMsg.renderSigle(o,"down"),n();Te.msgSyncSum=t}var i=Te.receptionist;Te.ioLinkStatus,Te.chatSocket;return{start:e}}(),tt=ce();tt.visibilitychange(function(){var e,t=Te.receptionist,i=Te.ioLinkStatus,n=Te.chatSocket;if(0==this.hidden&&"visible"==this.visibilityState){if(Te.isInIframe){var a,o,s,r="kf"+t.kfUin+"vId"+t.visitorId+"red",c=JSON.parse(Pe.get(r));c&&c.forEach(function(e){for(a in e)s=e[a],o=a.replace("wId",""),s.number>0&&(Te.isMobile?Ie.send({visitorid:t.visitorId,kfuin:t.kfUin,wpaId:o,act:"UNREAD",data:{number:s.number}}):$e.render("update",s.number))})}e="show",et.start(e),n.ioLink&&n.ioLink.disconnected&&~i.indexOf("over")&&(Te.ioLinkStatus="over")}else e="hide";Te.pageStatus=e}),function(e){var t=function(e,i){var n=/[^\w\-\.:]/.test(e)?new Function(t.arg+",tmpl","var _e=tmpl.encode"+t.helper+",_s='"+e.replace(t.regexp,t.func)+"';return _s;"):t.cache[e]=t.cache[e]||e;return i?n(i,t):function(e){return n(e,t)}};t.cache={},t.load=function(e){return document.getElementById(e).innerHTML},t.regexp=/([\s'\\])(?!(?:[^<]|\<(?!%))*%\>)|(?:\<%(=|#)([\s\S]+?)%\>)|(\<%)|(%\>)/g,t.func=function(e,t,i,n,a,o){return t?{"\n":"\\n","\r":"\\r","	":"\\t"," ":" "}[t]||"\\"+t:i?"="===i?"'+_e("+n+")+'":"'+("+n+"==null?'':"+n+")+'":a?"';":o?"_s+='":void 0},t.encReg=/[<>&"'\x00]/g,t.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"},t.encode=function(e){return(null==e?"":""+e).replace(t.encReg,function(e){return t.encMap[e]||""})},t.arg="o",t.helper=",print=function(s,e){_s+=e?(s==null?'':s):_e(s);},include=function(s,d){_s+=tmpl(s,d);}",e.tmpl=t}($);var it=new le;it.start()}();