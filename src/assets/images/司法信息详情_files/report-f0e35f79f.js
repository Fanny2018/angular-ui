!function(){"use strict";function e(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i)}function t(e,t,i,n,o){o&&(o=new Date(+new Date+o));var r=e+"="+escape(t)+(o?"; expires="+o.toGMTString():"")+(n?"; path="+n:"")+(i?"; domain="+i:"");return r.length<4096&&(a.cookie=r),this}function i(e){var t=a.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null}function n(){function e(){return Math.round(2147483647*(Math.random()||.5))*+new Date%1e10}function n(){var e=i(c);return"undefined"!=typeof window.isLocalStorageSupported&&window.isLocalStorageSupported&&(e?u.set(c,e):e=u.get(c)),e}function o(){var i=e();return"undefined"!=typeof window.isLocalStorageSupported&&window.isLocalStorageSupported?u.set(c,i):t(name,i,null,"/",31536e6),i}var r,c="tencentSig";return r=n(),r||(r=o()),r}function o(){this.create=function(e,t){return this.ioLink=io.connect(e,t),this},this.close=function(){this.ioLink.disconnect()},this.emitMsg=function(e,t,i,n){return this.ioLink.compress(!1).emit(e,t),i&&i.call(n),this},this.receiveMsg=function(e,t,i,n,o){var i=i||this;return o?this.ioLink.once(e,function(e){n&&$.extend(e,n),t&&t.call(i,e)}):this.ioLink.on(e,function(e){n&&$.extend(e,n),t&&t.call(i,e)}),this}}function r(){"chat"!=window.__domain.chat&&window.console&&window.console.trace&&"[object Function]"==Object.prototype.toString.apply(window.console.trace)&&window.console.trace(arguments)}var c=function(e,t){var i,n,e=e?e:window.location.href;if(t){i=new RegExp("[?&]"+t+"=([^&#]*)","i");try{n=i.exec(e)[1]}catch(o){n=null}}else n=e.substring(e.indexOf("?")+1);return n},a=document;if(window.isLocalStorageSupported=!1,window.localStorage&&window.localStorage.getItem)try{window.localStorage.setItem("test","test"),window.localStorage.removeItem("test"),window.isLocalStorageSupported=!0}catch(s){}var u={set:function(e,t){return window.isLocalStorageSupported?void window.localStorage.setItem(e,t):!1},get:function(e){var t=window.isLocalStorageSupported?window.localStorage.getItem(e):window.isLocalStorageSupported;return t?t:!1},remove:function(e){return window.isLocalStorageSupported&&window.localStorage.removeItem(e),this},clear:function(){return window.isLocalStorageSupported&&window.localStorage.clear(),this}};!function(e){var t=/iPhone/i,i=/iPod/i,n=/iPad/i,o=/(?=.*\bAndroid\b)(?=.*\bMobile\b)/i,r=/Android/i,c=/(?=.*\bAndroid\b)(?=.*\bSD4930UR\b)/i,a=/(?=.*\bAndroid\b)(?=.*\b(?:KFOT|KFTT|KFJWI|KFJWA|KFSOWI|KFTHWI|KFTHWA|KFAPWI|KFAPWA|KFARWI|KFASWI|KFSAWI|KFSAWA)\b)/i,s=/Windows Phone/i,u=/(?=.*\bWindows\b)(?=.*\bARM\b)/i,d=/BlackBerry/i,l=/BB10/i,f=/Opera Mini/i,p=/(CriOS|Chrome)(?=.*\bMobile\b)/i,h=/(?=.*\bFirefox\b)(?=.*\bMobile\b)/i,w=new RegExp("(?:Nexus 7|BNTV250|Kindle Fire|Silk|GT-P1000)","i"),v=function(e,t){return e.test(t)},g=function(e){var g=e||navigator.userAgent,b=g.split("[FBAN");return"undefined"!=typeof b[1]&&(g=b[0]),b=g.split("Twitter"),"undefined"!=typeof b[1]&&(g=b[0]),this.apple={phone:v(t,g),ipod:v(i,g),tablet:!v(t,g)&&v(n,g),device:v(t,g)||v(i,g)||v(n,g)},this.amazon={phone:v(c,g),tablet:!v(c,g)&&v(a,g),device:v(c,g)||v(a,g)},this.android={phone:v(c,g)||v(o,g),tablet:!v(c,g)&&!v(o,g)&&(v(a,g)||v(r,g)),device:v(c,g)||v(a,g)||v(o,g)||v(r,g)},this.windows={phone:v(s,g),tablet:v(u,g),device:v(s,g)||v(u,g)},this.other={blackberry:v(d,g),blackberry10:v(l,g),opera:v(f,g),firefox:v(h,g),chrome:v(p,g),device:v(d,g)||v(l,g)||v(f,g)||v(h,g)||v(p,g)},this.seven_inch=v(w,g),this.any=this.apple.device||this.android.device||this.windows.device||this.other.device||this.seven_inch,this.phone=this.apple.phone||this.android.phone||this.windows.phone,this.tablet=this.apple.tablet||this.android.tablet||this.windows.tablet,"undefined"==typeof window?this:void 0},b=function(){var e=new g;return e.Class=g,e};e.isMobile=b()}(window);var d=__domain||{chat:"chat"},l={link:"https://"+d.chat+".qidian.qq.com",opts:{path:"/status",reconnectionDelay:1e3,reconnectionDelayMax:2e3,reconnectionAttempts:2,timeout:1e3}},f={statusNotice:{emit:"active_notice"},b2cMsgNum:{receive:"b2c_msg_num",emit:"b2c_msg_num ack"},invitation:{receive:"session_invitation",emit:"user_operate"},inviteAutoConf:{emit:"invite_auto_conf",receive:"invite_auto_conf"}},p=function(t){function i(){var e=t.location.href,i=n(),o=c(e,"kfuin");M.sender({act:"SM_INIT",visitorId:i,kfuin:o,linkType:1,isMobile:Number(isMobile)})}function a(e){_.emitMsg(f.statusNotice.emit,e,function(t){0==t.errcode&&(r("上线通知成功"),!k&&u(e))})}function s(){for(var e=0,t=S.length;t>e;e++)a(S[e])}function u(e){_.emitMsg(f.inviteAutoConf.emit,e),_.receiveMsg(f.inviteAutoConf.receive,function(e){M.sender({act:"SM_INVITE_CONF",kfuin:e.body.invitationConf.kfuin,inviteRule:e.body.invitationConf})})}function d(){_.receiveMsg(f.b2cMsgNum.receive,function(e){_.emitMsg(f.b2cMsgNum.emit);var t=e.body;t.msgNum>0&&(t.number=t.msgNum,delete t.seq,delete t.msgNum,M.sender({act:"SM_UNREAD",kfuin:t.kfuin,data:t}))})}function p(){_.receiveMsg(f.invitation.receive,function(e){var t=e.body.kfuin;delete e.body.kfuin,M.sender({act:"SM_MANUAL_INVITE",kfuin:t,data:e.body})})}function h(e){_.emitMsg(f.invitation.emit,{operate:e})}function w(){_.emitMsg(f.invitation.emit,{action:"refuse"})}function v(e){_.create(l.link,l.opts),_.ioLink.once("connect",function(){"reconnect"==e?s():(b=0,M.sender({act:"SM_READY"}),d(),p(),k?i():"")}),_.ioLink.once("reconnect",function(){r("socket reconnect"),s()}),_.ioLink.on("disconnect",function(){M.sender({act:"DISCONNECT"})})}function g(){_.ioLink&&_.ioLink.disconnect(),v("reconnect")}var b=0,m={},S=[],k=function(){var e=t.location.href,i=c(e,"linkType"),n=c(e,"visitorId"),o=t.parent==t?!1:!0;return n&&n.length>0?i=1:"",i&&(""+i).length>0&&!o?!0:!1}(),M={receiver:function(){e(t,"message",function(e){var t="string"==typeof e.data?JSON.parse(e.data):e.data,i=t.act;switch(r("receiver data "+JSON.stringify(t)),i){case"SM_INIT":if(m&&m.kfuin==t.kfuin)return;m=t,m.linkType=t.linkType?1:0,S.push(m),a(m);break;case"SM_REFUSE":w();break;case"SMS_SM_FORCE_CONNECT":g();break;case"SM_INVITE_RET":h()}})},sender:function(e){r("sender data "+JSON.stringify(e)),parent.postMessage(JSON.stringify(e),"*")}},_=new o;return _.emitMsg=function(e,t,i,n){return this.ioLink.emit(e,t,function(){i&&i.apply(n,arguments)}),this},{start:function(){v(),M.receiver()},forceConnect:g}}(window);window.__STATUS_MANAGER=p,p.start()}();